# å…ƒæ•°æ®åˆå§‹åŒ–å·¥å…· - init.sql æ‰§è¡ŒåŠŸèƒ½

**æ·»åŠ æ—¥æœŸ**: 2026-01-12

## åŠŸèƒ½æ¦‚è¿°

ä¸º `metadata-init` å·¥å…·æ·»åŠ äº† `--init-db` å‚æ•°ï¼Œæ”¯æŒåœ¨å…ƒæ•°æ®åˆå§‹åŒ–å‰å…ˆæ‰§è¡Œ `sqls/init.sql` è„šæœ¬ï¼Œå®ç°æ•°æ®åº“å’Œå…ƒæ•°æ®çš„ä¸€é”®åˆå§‹åŒ–ã€‚

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å…¨æ–°ç¯å¢ƒå¿«é€Ÿéƒ¨ç½²

**éœ€æ±‚**: åœ¨å…¨æ–°çš„æœåŠ¡å™¨æˆ–å¼€å‘ç¯å¢ƒä¸­ï¼Œä¸€æ¬¡æ€§å®Œæˆæ•°æ®åº“åˆ›å»ºå’Œå…ƒæ•°æ®åˆå§‹åŒ–

```bash
# ä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰åˆå§‹åŒ–å·¥ä½œ
metadata-init --init-db

# æ‰§è¡Œæ­¥éª¤ï¼š
# 1. è¯»å–å¹¶æ‰§è¡Œ sqls/init.sqlï¼ˆåˆ›å»ºæ•°æ®åº“ã€è¡¨ç»“æ„ã€åˆå§‹æ•°æ®ï¼‰
# 2. åˆå§‹åŒ–åŸºç¡€æ•°æ®å­—å…¸ï¼ˆYESNOï¼‰
# 3. ä¸ºæ‰€æœ‰è¡¨ç”Ÿæˆå…ƒæ•°æ®å®šä¹‰
```

**ä¼˜åŠ¿**:
- âœ… æ— éœ€æ‰‹åŠ¨æ‰§è¡Œ SQL è„šæœ¬
- âœ… é¿å…é—æ¼åˆå§‹åŒ–æ­¥éª¤
- âœ… é€‚åˆè‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

### åœºæ™¯ 2: æµ‹è¯•ç¯å¢ƒé‡ç½®

**éœ€æ±‚**: å¿«é€Ÿé‡ç½®æµ‹è¯•ç¯å¢ƒåˆ°åˆå§‹çŠ¶æ€

```bash
# é‡æ–°åˆå§‹åŒ–æ•°æ®åº“å’Œå…ƒæ•°æ®
metadata-init --init-db --force

# æ‰§è¡Œæ­¥éª¤ï¼š
# 1. æ‰§è¡Œ init.sqlï¼ˆä¼šåˆ é™¤å¹¶é‡å»ºæ•°æ®åº“ï¼‰
# 2. åˆ é™¤å·²æœ‰å…ƒæ•°æ®
# 3. é‡æ–°ç”Ÿæˆæ‰€æœ‰å…ƒæ•°æ®
```

**ä¼˜åŠ¿**:
- âœ… å¿«é€Ÿæ¢å¤å¹²å‡€ç¯å¢ƒ
- âœ… ç¡®ä¿æµ‹è¯•æ•°æ®ä¸€è‡´æ€§
- âœ… èŠ‚çœäººå·¥æ“ä½œæ—¶é—´

### åœºæ™¯ 3: CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²

**éœ€æ±‚**: åœ¨æŒç»­é›†æˆæµç¨‹ä¸­è‡ªåŠ¨å®Œæˆæ•°æ®åº“åˆå§‹åŒ–

```yaml
# .gitlab-ci.yml ç¤ºä¾‹
deploy:
  script:
    - ./bin/metadata-init --init-db
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
- âœ… å‡å°‘äººå·¥å¹²é¢„
- âœ… æé«˜éƒ¨ç½²å¯é æ€§

### åœºæ™¯ 4: å¼€å‘ç¯å¢ƒåˆå§‹åŒ–

**éœ€æ±‚**: æ–°å›¢é˜Ÿæˆå‘˜å¿«é€Ÿæ­å»ºæœ¬åœ°å¼€å‘ç¯å¢ƒ

```bash
# å…‹éš†ä»£ç åä¸€é”®åˆå§‹åŒ–
git clone <repository>
cd sky-server
cp configs/config.yaml.example configs/config.yaml
# é…ç½®æ•°æ®åº“è¿æ¥ä¿¡æ¯...
metadata-init --init-db
```

**ä¼˜åŠ¿**:
- âœ… é™ä½ä¸Šæ‰‹é—¨æ§›
- âœ… ç»Ÿä¸€å¼€å‘ç¯å¢ƒ
- âœ… å‡å°‘é…ç½®é”™è¯¯

## æŠ€æœ¯å®ç°

### 1. æ–°å¢å‘½ä»¤è¡Œå‚æ•°

```go
initDB = flag.Bool("init-db", false, "åœ¨å…ƒæ•°æ®åˆå§‹åŒ–å‰å…ˆæ‰§è¡Œ sqls/init.sql åˆå§‹åŒ–æ•°æ®åº“")
```

### 2. executeInitSQL å‡½æ•°

**æ ¸å¿ƒåŠŸèƒ½**:
- è¯»å– `sqls/init.sql` æ–‡ä»¶
- ä½¿ç”¨ `multiStatements=true` å‚æ•°è¿æ¥æ•°æ®åº“
- æ‰§è¡Œå®Œæ•´çš„ SQL è„šæœ¬
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

**å®ç°ç»†èŠ‚**:

```go
func executeInitSQL(mysqlConfig *config.MySQLConfig) error {
    // 1. è¯»å– init.sql æ–‡ä»¶
    sqlFilePath := filepath.Join("sqls", "init.sql")
    sqlBytes, err := os.ReadFile(sqlFilePath)
    if err != nil {
        return fmt.Errorf("failed to read init.sql: %w", err)
    }

    // 2. æ„å»º DSNï¼ˆæ·»åŠ  multiStatements=true å‚æ•°ï¼‰
    dsn := fmt.Sprintf("%s:%s@tcp(%s:%d)/?charset=utf8mb4&parseTime=True&loc=Local&multiStatements=true",
        mysqlConfig.Username,
        mysqlConfig.Password,
        mysqlConfig.Host,
        mysqlConfig.Port,
    )

    // 3. åˆ›å»ºæ•°æ®åº“è¿æ¥
    db, err := sql.Open("mysql", dsn)
    if err != nil {
        return fmt.Errorf("failed to open database connection: %w", err)
    }
    defer db.Close()

    // 4. æ‰§è¡Œ SQL
    _, err = db.Exec(string(sqlBytes))
    if err != nil {
        return fmt.Errorf("failed to execute init.sql: %w", err)
    }

    return nil
}
```

### 3. æ‰§è¡Œé¡ºåº

```
main() å‡½æ•°æ‰§è¡Œæµç¨‹ï¼š
1. è§£æå‘½ä»¤è¡Œå‚æ•°
2. åŠ è½½é…ç½®æ–‡ä»¶
3. åˆå§‹åŒ–æ—¥å¿—
4. è¿æ¥æ•°æ®åº“
5. â­ æ‰§è¡Œ init.sqlï¼ˆå¦‚æœ --init-db å‚æ•°ä¸º trueï¼‰
6. åˆå§‹åŒ–åŸºç¡€æ•°æ®å­—å…¸
7. è·å–è¦åˆå§‹åŒ–çš„è¡¨
8. ä¸ºæ¯ä¸ªè¡¨åˆå§‹åŒ–å…ƒæ•°æ®
9. è¾“å‡ºç»Ÿè®¡ç»“æœ
```

**å…³é”®ç‚¹**: init.sql åœ¨å…ƒæ•°æ®åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®åº“ç»“æ„å·²å°±ç»ªã€‚

## å‚æ•°è¯´æ˜

### --init-db

**åŠŸèƒ½**: åœ¨å…ƒæ•°æ®åˆå§‹åŒ–å‰å…ˆæ‰§è¡Œ sqls/init.sql åˆå§‹åŒ–æ•°æ®åº“

**é»˜è®¤å€¼**: falseï¼ˆä¸æ‰§è¡Œï¼‰

**ä½¿ç”¨æ–¹å¼**:

```bash
# åŸºç¡€ç”¨æ³•
metadata-init --init-db

# ç»„åˆç”¨æ³•ï¼šæ‰§è¡Œ init.sql + å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
metadata-init --init-db --force

# ç»„åˆç”¨æ³•ï¼šæ‰§è¡Œ init.sql + åªåˆå§‹åŒ–ç³»ç»Ÿè¡¨
metadata-init --init-db --only-sys

# ç»„åˆç”¨æ³•ï¼šæ‰§è¡Œ init.sql + åªåˆå§‹åŒ–æŒ‡å®šè¡¨
metadata-init --init-db --tables sys_user,sys_company
```

**æ³¨æ„äº‹é¡¹**:

1. **ç¡®ä¿ init.sql å­˜åœ¨**: è¯¥å‚æ•°ä¼šè¯»å– `sqls/init.sql` æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ä¼šæŠ¥é”™
2. **æ£€æŸ¥ SQL å†…å®¹**: init.sql åº”åŒ…å«å®Œæ•´çš„æ•°æ®åº“åˆå§‹åŒ–é€»è¾‘
3. **æ•°æ®åº“æƒé™**: æ‰§è¡Œ init.sql éœ€è¦è¶³å¤Ÿçš„æ•°æ®åº“æƒé™ï¼ˆåˆ›å»ºæ•°æ®åº“ã€è¡¨ç­‰ï¼‰
4. **å¹‚ç­‰æ€§**: init.sql åº”ä½¿ç”¨ `CREATE DATABASE IF NOT EXISTS` ç­‰è¯­å¥ç¡®ä¿å¹‚ç­‰æ€§

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: å…¨æ–°éƒ¨ç½²

```bash
# ç¬¬ä¸€æ¬¡éƒ¨ç½²åˆ°æ–°æœåŠ¡å™¨
metadata-init --init-db

# è¾“å‡ºï¼š
# 2026-01-12T10:00:00.000+0800    INFO    Starting metadata initialization
# 2026-01-12T10:00:00.100+0800    INFO    Database connected successfully
# 2026-01-12T10:00:00.150+0800    INFO    Executing init.sql before metadata initialization
# 2026-01-12T10:00:00.200+0800    INFO    Executing SQL script {"file": "sqls/init.sql"}
# 2026-01-12T10:00:01.500+0800    INFO    SQL script executed successfully
# 2026-01-12T10:00:01.550+0800    INFO    init.sql executed successfully
# 2026-01-12T10:00:01.600+0800    INFO    Base dictionaries initialized
# 2026-01-12T10:00:01.650+0800    INFO    Found tables {"count": 35, "filter": "all tables"}
# ...
# 2026-01-12T10:00:05.000+0800    INFO    Metadata initialization completed {"success": 35, "skipped": 0, "failed": 0, "total": 35}
```

### ç¤ºä¾‹ 2: æµ‹è¯•ç¯å¢ƒé‡ç½®

```bash
# é‡ç½®æµ‹è¯•ç¯å¢ƒï¼ˆåˆ é™¤å¹¶é‡å»ºï¼‰
metadata-init --init-db --force

# è¯´æ˜ï¼š
# 1. init.sql ä¸­çš„ DROP DATABASE ä¼šåˆ é™¤æ—§æ•°æ®åº“
# 2. é‡æ–°åˆ›å»ºæ‰€æœ‰è¡¨ç»“æ„
# 3. --force å‚æ•°ç¡®ä¿å…ƒæ•°æ®ä¹Ÿè¢«é‡æ–°åˆ›å»º
```

### ç¤ºä¾‹ 3: åªåˆå§‹åŒ–ç³»ç»Ÿè¡¨

```bash
# æ‰§è¡Œ init.sql ååªåˆå§‹åŒ–ç³»ç»Ÿè¡¨å…ƒæ•°æ®
metadata-init --init-db --only-sys

# åœºæ™¯ï¼š
# - æ•°æ®åº“ç»“æ„éœ€è¦å®Œæ•´åˆ›å»º
# - ä½†å…ƒæ•°æ®åªéœ€è¦ç³»ç»Ÿè¡¨éƒ¨åˆ†
```

## init.sql è¦æ±‚

ä¸ºäº†é…åˆ `--init-db` å‚æ•°ä½¿ç”¨ï¼Œ`sqls/init.sql` åº”éµå¾ªä»¥ä¸‹è§„èŒƒï¼š

### 1. å¹‚ç­‰æ€§è®¾è®¡ âœ…

```sql
-- ä½¿ç”¨ IF NOT EXISTS ç¡®ä¿å¯é‡å¤æ‰§è¡Œ
CREATE DATABASE IF NOT EXISTS skyserver CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE skyserver;

-- è¡¨åˆ›å»ºä¹Ÿåº”ä½¿ç”¨ DROP ... IF EXISTS
DROP TABLE IF EXISTS `sys_table`;
CREATE TABLE `sys_table` (
  ...
);
```

### 2. å®Œæ•´æ€§ âœ…

init.sql åº”åŒ…å«ï¼š
- âœ… æ•°æ®åº“åˆ›å»ºè¯­å¥
- âœ… æ‰€æœ‰è¡¨ç»“æ„å®šä¹‰
- âœ… åˆå§‹æ•°æ®ï¼ˆæµ‹è¯•å…¬å¸ã€ç®¡ç†å‘˜è´¦æˆ·ç­‰ï¼‰
- âœ… ç´¢å¼•å’Œçº¦æŸå®šä¹‰

### 3. æ­£ç¡®çš„ç¼–ç è®¾ç½® âœ…

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;
-- SQL è¯­å¥...
SET FOREIGN_KEY_CHECKS = 1;
```

### 4. é”™è¯¯å¤„ç† âœ…

```sql
-- ä½¿ç”¨ ON DUPLICATE KEY UPDATE é¿å…é‡å¤æ’å…¥é”™è¯¯
INSERT INTO sys_company (ID, SYS_COMPANY_ID, NAME, IS_ACTIVE)
VALUES (1, 1, 'æµ‹è¯•å…¬å¸', 'Y')
ON DUPLICATE KEY UPDATE NAME = 'æµ‹è¯•å…¬å¸';
```

## å¸¸è§é—®é¢˜

### Q1: --init-db å’Œç›´æ¥æ‰§è¡Œ SQL æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A**:
- **ç›´æ¥æ‰§è¡Œ**: `mysql -u root -p < sqls/init.sql`
  - éœ€è¦æ‰‹åŠ¨æ“ä½œ
  - éœ€è¦è®°ä½æ–‡ä»¶è·¯å¾„
  - å®¹æ˜“é—æ¼æ­¥éª¤

- **ä½¿ç”¨ --init-db**: `metadata-init --init-db`
  - ä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰æ“ä½œ
  - è‡ªåŠ¨å®šä½ SQL æ–‡ä»¶
  - ä¸å…ƒæ•°æ®åˆå§‹åŒ–æ— ç¼é›†æˆ

### Q2: å¦‚æœ init.sql æ‰§è¡Œå¤±è´¥ä¼šæ€æ ·ï¼Ÿ

**A**:
- å·¥å…·ä¼šç«‹å³ç»ˆæ­¢å¹¶æŠ¥é”™
- é”™è¯¯ä¿¡æ¯ä¼šæ˜¾ç¤ºå¤±è´¥åŸå› 
- ä¸ä¼šç»§ç»­æ‰§è¡Œå…ƒæ•°æ®åˆå§‹åŒ–
- ç¡®ä¿ç³»ç»Ÿå¤„äºä¸€è‡´çŠ¶æ€

```bash
# é”™è¯¯ç¤ºä¾‹è¾“å‡º
2026-01-12T10:00:00.200+0800    FATAL   Failed to execute init.sql
Error: failed to execute init.sql: Error 1050: Table 'sys_table' already exists
```

### Q3: init.sql å¯ä»¥åªåŒ…å«éƒ¨åˆ†è¡¨å—ï¼Ÿ

**A**:
å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚æœ€ä½³å®è·µï¼š
- âœ… **æ¨è**: init.sql åŒ…å«å®Œæ•´çš„æ•°æ®åº“åˆå§‹åŒ–
- âš ï¸ **ä¸æ¨è**: éƒ¨åˆ†è¡¨ç”± init.sql åˆ›å»ºï¼Œéƒ¨åˆ†æ‰‹åŠ¨åˆ›å»º
- ğŸ“Œ **åŸå› **: ä¿æŒä¸€è‡´æ€§ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œè‡ªåŠ¨åŒ–éƒ¨ç½²

### Q4: æ¯æ¬¡è¿è¡Œéƒ½è¦åŠ  --init-db å—ï¼Ÿ

**A**:
ä¸éœ€è¦ã€‚æ ¹æ®åœºæ™¯é€‰æ‹©ï¼š

| åœºæ™¯ | æ˜¯å¦ä½¿ç”¨ --init-db |
|-----|------------------|
| å…¨æ–°ç¯å¢ƒéƒ¨ç½² | âœ… æ˜¯ |
| æ–°å¢ä¸šåŠ¡è¡¨å | âŒ å¦ |
| æµ‹è¯•ç¯å¢ƒé‡ç½® | âœ… æ˜¯ |
| æ—¥å¸¸å¼€å‘è°ƒè¯• | âŒ å¦ |
| CI/CD éƒ¨ç½² | âœ… æ˜¯ |

### Q5: --init-db ä¼šåˆ é™¤ç°æœ‰æ•°æ®å—ï¼Ÿ

**A**:
å–å†³äº init.sql çš„å†…å®¹ï¼š
- å¦‚æœ init.sql åŒ…å« `DROP DATABASE` â†’ âš ï¸ ä¼šåˆ é™¤
- å¦‚æœ init.sql åŒ…å« `DROP TABLE` â†’ âš ï¸ ä¼šåˆ é™¤å¯¹åº”è¡¨
- å¦‚æœä½¿ç”¨ `CREATE ... IF NOT EXISTS` â†’ âœ… ä¸ä¼šåˆ é™¤

**å®‰å…¨å»ºè®®**:
```bash
# ç”Ÿäº§ç¯å¢ƒï¼šè°¨æ…ä½¿ç”¨ --init-db
# æµ‹è¯•ç¯å¢ƒï¼šå¯ä»¥æ”¾å¿ƒä½¿ç”¨ --init-db --force
# å¼€å‘ç¯å¢ƒï¼šé¦–æ¬¡ä½¿ç”¨ --init-dbï¼Œä¹‹åä¸ç”¨
```

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|-----|------|---------|
| v1.1.0 | 2026-01-12 | æ·»åŠ  --init-db å‚æ•°æ”¯æŒ |
| v1.0.0 | 2026-01-11 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒå…ƒæ•°æ®åˆå§‹åŒ– |

## ç›¸å…³æ–‡æ¡£

- [å…ƒæ•°æ®åˆå§‹åŒ–å·¥å…·ä½¿ç”¨æŒ‡å—](./metadata-init-guide.md)
- [å…ƒæ•°æ®åˆå§‹åŒ–å·¥å…·å‡çº§æ€»ç»“](./metadata-init-upgrade-summary.md)
- [æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬è¯´æ˜](../sqls/README.md)

## æ€»ç»“

`--init-db` å‚æ•°çš„å¼•å…¥å¤§å¤§ç®€åŒ–äº†ç³»ç»Ÿéƒ¨ç½²æµç¨‹ï¼š

âœ… **ä¸€é”®éƒ¨ç½²**: å•æ¡å‘½ä»¤å®Œæˆæ•°æ®åº“å’Œå…ƒæ•°æ®åˆå§‹åŒ–
âœ… **è‡ªåŠ¨åŒ–å‹å¥½**: é€‚åˆ CI/CD æµç¨‹é›†æˆ
âœ… **é™ä½é—¨æ§›**: æ–°æ‰‹ä¹Ÿèƒ½å¿«é€Ÿæ­å»ºç¯å¢ƒ
âœ… **å‡å°‘é”™è¯¯**: é¿å…æ‰‹åŠ¨æ“ä½œå¯¼è‡´çš„é—æ¼
âœ… **çµæ´»ç»„åˆ**: å¯ä¸å…¶ä»–å‚æ•°ç»„åˆä½¿ç”¨

è¿™ä¸ªåŠŸèƒ½ç‰¹åˆ«é€‚åˆï¼š
- ğŸš€ DevOps è‡ªåŠ¨åŒ–éƒ¨ç½²
- ğŸ‘¨â€ğŸ’» å¼€å‘ç¯å¢ƒå¿«é€Ÿæ­å»º
- ğŸ§ª æµ‹è¯•ç¯å¢ƒé¢‘ç¹é‡ç½®
- ğŸ“¦ å®¹å™¨åŒ–éƒ¨ç½²åœºæ™¯
