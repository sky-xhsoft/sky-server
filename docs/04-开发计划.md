# Sky-Server 开发计划文档

## 1. 项目概述

### 1.1 项目目标

开发一个基于元数据驱动的企业级应用框架，通过配置化的方式快速构建企业管理系统，减少重复的CRUD代码开发工作。

### 1.2 项目周期

整个项目分为5个阶段，每个阶段专注于特定的功能模块开发。

## 2. 开发阶段划分

### 第一阶段：基础框架搭建

**目标**: 搭建项目基础架构，实现基本的开发环境和工具链

**主要任务**:

1. **项目初始化**
   - [ ] 创建Go Module
   - [ ] 设置项目目录结构
   - [ ] 配置.gitignore和.editorconfig
   - [ ] 编写README.md

2. **基础设施**
   - [ ] 集成Gin Web框架
   - [ ] 集成GORM ORM
   - [ ] 集成Viper配置管理
   - [ ] 集成Zap日志框架
   - [ ] 集成Redis客户端

3. **配置管理**
   - [ ] 创建配置文件结构（config.yaml）
   - [ ] 实现配置加载和解析
   - [ ] 支持多环境配置（dev/test/prod）

4. **数据库连接**
   - [ ] 实现MySQL连接池
   - [ ] 实现Redis连接池
   - [ ] 数据库健康检查
   - [ ] 实现数据库迁移工具集成

5. **中间件**
   - [ ] 日志中间件（请求/响应日志）
   - [ ] 错误处理中间件
   - [ ] CORS中间件
   - [ ] 请求ID中间件
   - [ ] 恢复中间件（panic recovery）

6. **工具类**
   - [ ] HTTP响应封装
   - [ ] 错误码定义
   - [ ] 时间工具
   - [ ] 字符串工具
   - [ ] 验证器工具

**交付成果**:
- 完整的项目框架
- 可运行的最小系统（Hello World）
- 基础中间件和工具类
- 开发环境配置文档

### 第二阶段：认证授权模块

**目标**: 实现用户认证、JWT令牌管理和基础权限控制

**主要任务**:

1. **数据模型**
   - [ ] 定义User、Company、Groups等实体模型
   - [ ] 实现数据库实体映射（GORM）
   - [ ] 编写模型单元测试

2. **用户认证**
   - [ ] 实现用户登录接口
   - [ ] 实现JWT Token生成和验证
   - [ ] 实现Token刷新机制
   - [ ] 实现登出功能
   - [ ] 密码加密（bcrypt）

3. **权限控制**
   - [ ] 实现权限检查中间件
   - [ ] 实现基于角色的访问控制（RBAC）
   - [ ] 实现多租户数据隔离
   - [ ] 实现字段级权限控制（SGRADE）

4. **用户管理**
   - [ ] 用户CRUD接口
   - [ ] 修改密码接口
   - [ ] 获取当前用户信息接口

5. **测试**
   - [ ] 单元测试
   - [ ] 集成测试
   - [ ] API测试

**交付成果**:
- 完整的认证授权模块
- 用户管理API
- 权限控制中间件
- 单元测试和集成测试

### 第三阶段：元数据服务

**目标**: 实现元数据加载、缓存和查询功能

**主要任务**:

1. **元数据模型**
   - [ ] 定义Table、Column、TableRef等实体
   - [ ] 实现元数据仓储层（Repository）
   - [ ] 实现元数据DTO和VO

2. **元数据加载**
   - [ ] 实现从数据库加载元数据
   - [ ] 实现元数据验证
   - [ ] 实现元数据缓存（Redis）
   - [ ] 实现缓存刷新机制

3. **元数据服务**
   - [ ] 实现获取表元数据接口
   - [ ] 实现获取字段元数据接口
   - [ ] 实现获取表关系接口
   - [ ] 实现表列表查询接口

4. **元数据API**
   - [ ] GET /api/v1/metadata/tables
   - [ ] GET /api/v1/metadata/tables/{tableName}
   - [ ] POST /api/v1/metadata/refresh

5. **测试**
   - [ ] 元数据加载测试
   - [ ] 缓存功能测试
   - [ ] API集成测试

**交付成果**:
- 元数据服务模块
- 元数据缓存机制
- 元数据查询API
- 单元测试和集成测试

### 第四阶段：通用CRUD引擎

**目标**: 实现基于元数据的通用CRUD操作

**主要任务**:

1. **动态SQL构建**
   - [ ] 实现查询SQL构建器
   - [ ] 实现插入SQL构建器
   - [ ] 实现更新SQL构建器
   - [ ] 实现删除SQL构建器
   - [ ] 实现过滤条件解析器

2. **字段赋值处理**
   - [ ] 实现pk赋值（主键自增）
   - [ ] 实现docno赋值（单据编号）
   - [ ] 实现createBy/operator赋值
   - [ ] 实现sysdate赋值
   - [ ] 实现fk赋值（外键关联）
   - [ ] 实现select赋值（字典值）

3. **数据验证**
   - [ ] 实现必填验证
   - [ ] 实现正则表达式验证
   - [ ] 实现长度验证
   - [ ] 实现类型验证
   - [ ] 实现唯一性验证

4. **CRUD服务**
   - [ ] 实现Create服务
   - [ ] 实现Update服务
   - [ ] 实现Delete服务（软删除）
   - [ ] 实现Query服务（单条查询）
   - [ ] 实现List服务（列表查询+分页）

5. **CRUD API**
   - [ ] POST /api/v1/data/{tableName}
   - [ ] PUT /api/v1/data/{tableName}/{id}
   - [ ] DELETE /api/v1/data/{tableName}/{id}
   - [ ] GET /api/v1/data/{tableName}/{id}
   - [ ] GET /api/v1/data/{tableName}

6. **权限集成**
   - [ ] 集成权限检查
   - [ ] 应用数据过滤
   - [ ] 字段权限过滤

7. **测试**
   - [ ] SQL构建器测试
   - [ ] 字段赋值测试
   - [ ] 数据验证测试
   - [ ] CRUD功能测试
   - [ ] 权限集成测试

**交付成果**:
- 通用CRUD引擎
- 动态SQL构建器
- 数据验证框架
- CRUD API
- 单元测试和集成测试

### 第五阶段：高级功能

**目标**: 实现动作执行、单据编号、数据字典等高级功能

**主要任务**:

1. **单据编号服务**
   - [ ] 实现单据编号生成器
   - [ ] 实现格式解析器
   - [ ] 实现循环类型处理（日/月/年）
   - [ ] 实现并发控制（分布式锁）
   - [ ] API: POST /api/v1/sequence/{seqName}/next

2. **数据字典服务**
   - [ ] 实现字典CRUD
   - [ ] 实现字典项CRUD
   - [ ] 实现字典缓存
   - [ ] API: GET /api/v1/dict
   - [ ] API: GET /api/v1/dict/{dictName}/items

3. **动作执行服务**
   - [ ] 实现URL类型动作
   - [ ] 实现JavaScript类型动作
   - [ ] 实现存储过程类型动作
   - [ ] 实现Python类型动作（可选）
   - [ ] API: POST /api/v1/action/{actionId}/execute

4. **表命令钩子**
   - [ ] 实现before钩子
   - [ ] 实现after钩子
   - [ ] 集成到CRUD流程

5. **批量操作**
   - [ ] 批量创建
   - [ ] 批量更新
   - [ ] 批量删除
   - [ ] 事务处理

6. **导入导出**
   - [ ] Excel导出功能
   - [ ] Excel导入功能
   - [ ] CSV导出功能
   - [ ] 模板下载功能

7. **文件上传**
   - [ ] 实现文件上传接口
   - [ ] 实现文件存储（本地/OSS）
   - [ ] 实现文件下载接口
   - [ ] 文件类型验证

8. **系统配置**
   - [ ] 系统参数管理
   - [ ] 用户环境变量
   - [ ] 配置缓存

9. **测试**
   - [ ] 单元测试
   - [ ] 集成测试
   - [ ] 性能测试

**交付成果**:
- 完整的高级功能模块
- 单据编号生成器
- 数据字典服务
- 动作执行引擎
- 导入导出功能
- 单元测试和性能测试

### 第六阶段：完善和优化

**目标**: 系统优化、文档完善、部署准备

**主要任务**:

1. **性能优化**
   - [ ] SQL查询优化
   - [ ] 索引优化建议
   - [ ] 缓存策略优化
   - [ ] 并发性能测试
   - [ ] 内存优化

2. **监控和日志**
   - [ ] 集成Prometheus指标
   - [ ] 实现访问日志
   - [ ] 实现错误日志
   - [ ] 实现慢查询日志
   - [ ] 实现审计日志

3. **API文档**
   - [ ] 集成Swagger
   - [ ] 生成API文档
   - [ ] 编写API使用示例

4. **部署**
   - [ ] 编写Dockerfile
   - [ ] 编写docker-compose.yml
   - [ ] 编写部署脚本
   - [ ] 编写运维文档

5. **测试**
   - [ ] 端到端测试
   - [ ] 压力测试
   - [ ] 安全测试

6. **文档**
   - [ ] 完善开发文档
   - [ ] 编写部署文档
   - [ ] 编写运维手册
   - [ ] 编写用户手册

**交付成果**:
- 优化后的系统
- 完整的监控体系
- 完整的API文档
- 部署脚本和文档
- 运维手册

## 3. 技术规范

### 3.1 代码规范

- 遵循Go官方代码规范
- 使用golangci-lint进行代码检查
- 函数命名采用驼峰命名法
- 包名使用小写单词
- 注释遵循GoDoc规范

### 3.2 Git规范

**分支策略**:
- master: 主分支，保持稳定
- develop: 开发分支
- feature/xxx: 功能分支
- bugfix/xxx: 修复分支
- release/vX.X.X: 发布分支

**提交规范**:
```
<type>(<scope>): <subject>

<body>

<footer>
```

**type类型**:
- feat: 新功能
- fix: 修复bug
- docs: 文档变更
- style: 代码格式
- refactor: 重构
- test: 测试
- chore: 构建/工具变更

**示例**:
```
feat(auth): 添加JWT认证功能

- 实现JWT token生成
- 实现token验证中间件
- 添加token刷新接口

Close #123
```

### 3.3 测试规范

- 单元测试覆盖率 >= 70%
- 核心模块覆盖率 >= 90%
- 测试文件命名：xxx_test.go
- 使用testify断言库
- 使用gomock进行mock

### 3.4 文档规范

- 每个包必须有包级注释
- 导出的函数必须有注释
- 复杂逻辑必须有注释说明
- API使用Swagger注解

## 4. 开发工具

### 4.1 必备工具

- Go 1.21+
- MySQL 8.0+
- Redis 6.0+
- Git
- Docker
- Make

### 4.2 推荐IDE

- GoLand（推荐）
- VSCode + Go插件

### 4.3 开发插件

- golangci-lint: 代码检查
- goimports: 导入整理
- swag: Swagger文档生成
- air: 热重载
- golang-migrate: 数据库迁移

## 5. 质量保证

### 5.1 代码审查

- 所有代码必须经过Code Review
- 至少1人审查通过才能合并
- 审查清单：
  - [ ] 代码符合规范
  - [ ] 有充分的单元测试
  - [ ] 有必要的注释
  - [ ] 无明显性能问题
  - [ ] 无安全隐患

### 5.2 自动化测试

- 提交代码时自动运行单元测试
- 合并到develop时运行集成测试
- 发布前运行完整测试套件

### 5.3 性能基准

- API响应时间 < 100ms（P95）
- 列表查询 < 200ms（P95）
- 并发支持 >= 1000 QPS
- 数据库连接池 <= 100

## 6. 风险管理

### 6.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 元数据复杂度高 | 高 | 中 | 充分设计和测试 |
| 性能瓶颈 | 中 | 中 | 性能测试和优化 |
| 并发问题 | 高 | 低 | 使用分布式锁 |
| 安全漏洞 | 高 | 低 | 安全测试和审计 |

### 6.2 进度风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 需求变更 | 中 | 高 | 敏捷开发，迭代交付 |
| 技术难题 | 中 | 中 | 技术预研，寻求支持 |
| 资源不足 | 高 | 低 | 合理规划，优先级管理 |

## 7. 里程碑

| 阶段 | 里程碑 | 交付内容 |
|------|--------|----------|
| 阶段一 | 基础框架完成 | 可运行的项目框架 |
| 阶段二 | 认证授权完成 | 用户登录和权限控制 |
| 阶段三 | 元数据服务完成 | 元数据查询API |
| 阶段四 | CRUD引擎完成 | 通用CRUD功能 |
| 阶段五 | 高级功能完成 | 完整的业务功能 |
| 阶段六 | 系统发布 | 可部署的生产版本 |

## 8. 参考资料

### 8.1 技术文档

- [Go官方文档](https://golang.org/doc/)
- [Gin框架文档](https://gin-gonic.com/docs/)
- [GORM文档](https://gorm.io/docs/)
- [Redis文档](https://redis.io/documentation)

### 8.2 设计模式

- 仓储模式（Repository Pattern）
- 服务模式（Service Pattern）
- 工厂模式（Factory Pattern）
- 策略模式（Strategy Pattern）
- 装饰器模式（Decorator Pattern）

### 8.3 最佳实践

- [Effective Go](https://golang.org/doc/effective_go)
- [Go Code Review Comments](https://github.com/golang/go/wiki/CodeReviewComments)
- [Uber Go Style Guide](https://github.com/uber-go/guide/blob/master/style.md)

## 9. 附录

### 9.1 常用命令

```bash
# 运行项目
make run

# 运行测试
make test

# 代码检查
make lint

# 生成Swagger文档
make swagger

# 构建
make build

# 数据库迁移
make migrate-up

# 创建新的迁移文件
make migrate-create name=add_user_table
```

### 9.2 环境变量

```bash
# 应用配置
APP_ENV=development        # 环境（development/test/production）
APP_PORT=9090             # 端口

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=abc123
DB_NAME=skyserver

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# JWT配置
JWT_SECRET=your-secret-key
JWT_EXPIRE=7200          # 过期时间（秒）
```

### 9.3 项目联系方式

- 项目仓库: https://github.com/sky-xhsoft/sky-server
- 问题反馈: https://github.com/sky-xhsoft/sky-server/issues
