# Phase 6 å®Œæˆæ€»ç»“ - å·¥ä½œæµå¼•æ“

## æ¦‚è¿°

Phase 6 å·²å®Œæˆ,æˆåŠŸå®ç°äº†å®Œæ•´çš„å·¥ä½œæµå¼•æ“,æ”¯æŒ:
- æµç¨‹å®šä¹‰ç®¡ç†
- æµç¨‹èŠ‚ç‚¹å’Œæµè½¬é…ç½®
- æµç¨‹å®ä¾‹æ‰§è¡Œ
- ç”¨æˆ·ä»»åŠ¡åˆ†é…å’Œå¤„ç†
- è‡ªåŠ¨ä»»åŠ¡æ‰§è¡Œ

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ‰©å±•èƒ½åŠ›,ä½¿ç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒå¤æ‚çš„ä¸šåŠ¡å®¡æ‰¹æµç¨‹ã€‚

## å·²å®ŒæˆåŠŸèƒ½

### 1. æ•°æ®æ¨¡å‹è®¾è®¡

#### 1.1 wf_definition - æµç¨‹å®šä¹‰è¡¨
```go
type WfDefinition struct {
    BaseModel
    Name        string // æµç¨‹åç§°
    DisplayName string // æ˜¾ç¤ºåç§°
    Version     int    // ç‰ˆæœ¬å·
    Status      string // draft:è‰ç¨¿, published:å·²å‘å¸ƒ, archived:å·²å½’æ¡£
    SysTableID  int    // å…³è”çš„ä¸šåŠ¡è¡¨
    Description string // æè¿°
    Config      string // JSONé…ç½®
}
```

**åŠŸèƒ½:**
- âœ… æ”¯æŒå¤šç‰ˆæœ¬ç®¡ç†
- âœ… è‰ç¨¿-å‘å¸ƒ-å½’æ¡£ç”Ÿå‘½å‘¨æœŸ
- âœ… å¯å…³è”ä¸šåŠ¡è¡¨

#### 1.2 wf_node - æµç¨‹èŠ‚ç‚¹è¡¨
```go
type WfNode struct {
    BaseModel
    WfDefinitionID uint   // æ‰€å±æµç¨‹å®šä¹‰
    Name           string // èŠ‚ç‚¹åç§°
    DisplayName    string // æ˜¾ç¤ºåç§°
    NodeType       string // èŠ‚ç‚¹ç±»å‹
    AssignType     string // åˆ†é…ç±»å‹
    AssignValue    string // åˆ†é…å€¼
    ActionID       uint   // è‡ªåŠ¨ä»»åŠ¡å…³è”çš„åŠ¨ä½œID
    Config         string // JSONé…ç½®
    PosX           int    // Xåæ ‡(ç”¨äºæµç¨‹å›¾)
    PosY           int    // Yåæ ‡(ç”¨äºæµç¨‹å›¾)
}
```

**èŠ‚ç‚¹ç±»å‹:**
- âœ… **start** - å¼€å§‹èŠ‚ç‚¹
- âœ… **end** - ç»“æŸèŠ‚ç‚¹
- âœ… **user** - ç”¨æˆ·ä»»åŠ¡èŠ‚ç‚¹(éœ€è¦äººå·¥å®¡æ‰¹)
- âœ… **auto** - è‡ªåŠ¨ä»»åŠ¡èŠ‚ç‚¹(æ‰§è¡ŒåŠ¨ä½œ)
- âœ… **gateway** - ç½‘å…³èŠ‚ç‚¹(æ¡ä»¶åˆ†æ”¯)

**ä»»åŠ¡åˆ†é…ç±»å‹:**
- âœ… **user** - æŒ‡å®šç”¨æˆ·ID
- âœ… **starter** - æµç¨‹å‘èµ·äºº
- ğŸ”œ **role** - è§’è‰²(å¾…å®ç°)
- ğŸ”œ **expression** - è¡¨è¾¾å¼(å¾…å®ç°)

#### 1.3 wf_transition - æµç¨‹æµè½¬è¡¨
```go
type WfTransition struct {
    BaseModel
    WfDefinitionID uint   // æ‰€å±æµç¨‹å®šä¹‰
    FromNodeID     uint   // èµ·å§‹èŠ‚ç‚¹
    ToNodeID       uint   // ç›®æ ‡èŠ‚ç‚¹
    Name           string // æµè½¬åç§°
    Condition      string // æµè½¬æ¡ä»¶è¡¨è¾¾å¼
    Orderno        int    // ä¼˜å…ˆçº§é¡ºåº
}
```

**åŠŸèƒ½:**
- âœ… å®šä¹‰èŠ‚ç‚¹ä¹‹é—´çš„æµè½¬å…³ç³»
- âœ… æ”¯æŒæ¡ä»¶æµè½¬(è¡¨è¾¾å¼)
- âœ… æ”¯æŒä¼˜å…ˆçº§æ’åº

#### 1.4 wf_instance - æµç¨‹å®ä¾‹è¡¨
```go
type WfInstance struct {
    BaseModel
    WfDefinitionID uint      // æµç¨‹å®šä¹‰ID
    SysTableID     int       // å…³è”çš„ä¸šåŠ¡è¡¨
    BusinessID     uint      // ä¸šåŠ¡æ•°æ®ID
    Status         string    // çŠ¶æ€
    CurrentNodeID  uint      // å½“å‰èŠ‚ç‚¹ID
    StartUserID    uint      // å‘èµ·äºº
    StartTime      time.Time // å¼€å§‹æ—¶é—´
    EndTime        time.Time // ç»“æŸæ—¶é—´
    Variables      string    // æµç¨‹å˜é‡(JSON)
    Title          string    // æµç¨‹æ ‡é¢˜
}
```

**æµç¨‹çŠ¶æ€:**
- âœ… **running** - è¿è¡Œä¸­
- âœ… **completed** - å·²å®Œæˆ
- âœ… **terminated** - å·²ç»ˆæ­¢
- âœ… **suspended** - å·²æŒ‚èµ·

**åŠŸèƒ½:**
- âœ… å…³è”ä¸šåŠ¡æ•°æ®
- âœ… è®°å½•å½“å‰èŠ‚ç‚¹
- âœ… æ”¯æŒæµç¨‹å˜é‡ä¼ é€’
- âœ… æ”¯æŒæŒ‚èµ·/æ¢å¤/ç»ˆæ­¢

#### 1.5 wf_task - å·¥ä½œæµä»»åŠ¡è¡¨
```go
type WfTask struct {
    BaseModel
    WfInstanceID uint      // æµç¨‹å®ä¾‹ID
    WfNodeID     uint      // æµç¨‹èŠ‚ç‚¹ID
    AssigneeID   uint      // ä»»åŠ¡æ‰§è¡Œäºº
    Status       string    // çŠ¶æ€
    Action       string    // æ“ä½œ
    Comment      string    // å®¡æ‰¹æ„è§
    ClaimTime    time.Time // ç­¾æ”¶æ—¶é—´
    CompleteTime time.Time // å®Œæˆæ—¶é—´
    DueTime      time.Time // æˆªæ­¢æ—¶é—´
    Priority     int       // ä¼˜å…ˆçº§
    Variables    string    // ä»»åŠ¡å˜é‡(JSON)
}
```

**ä»»åŠ¡çŠ¶æ€:**
- âœ… **pending** - å¾…å¤„ç†
- âœ… **completed** - å·²å®Œæˆ
- âœ… **rejected** - å·²æ‹’ç»
- âœ… **transferred** - å·²è½¬äº¤

**ä»»åŠ¡æ“ä½œ:**
- âœ… **approve** - åŒæ„
- âœ… **reject** - æ‹’ç»
- âœ… **transfer** - è½¬äº¤

### 2. å·¥ä½œæµæœåŠ¡ (workflow_service.go)

#### 2.1 æµç¨‹å®šä¹‰ç®¡ç†

**æ¥å£å®šä¹‰:**
```go
type Service interface {
    CreateDefinition(ctx context.Context, def *entity.WfDefinition) error
    GetDefinition(ctx context.Context, id uint) (*entity.WfDefinition, error)
    UpdateDefinition(ctx context.Context, def *entity.WfDefinition) error
    PublishDefinition(ctx context.Context, id uint) error
    ListDefinitions(ctx context.Context, status string, page, pageSize int) ([]*entity.WfDefinition, int64, error)
}
```

**åŠŸèƒ½ç‰¹æ€§:**
- âœ… åˆ›å»ºæµç¨‹å®šä¹‰(é»˜è®¤è‰ç¨¿çŠ¶æ€)
- âœ… æ›´æ–°æµç¨‹å®šä¹‰(ä»…è‰ç¨¿çŠ¶æ€å¯æ›´æ–°)
- âœ… å‘å¸ƒæµç¨‹å®šä¹‰(éªŒè¯å®Œæ•´æ€§:å¿…é¡»æœ‰å¼€å§‹å’Œç»“æŸèŠ‚ç‚¹)
- âœ… æŸ¥è¯¢æµç¨‹å®šä¹‰åˆ—è¡¨(æ”¯æŒæŒ‰çŠ¶æ€ç­›é€‰)
- âœ… åˆ†é¡µæŸ¥è¯¢

#### 2.2 æµç¨‹èŠ‚ç‚¹ç®¡ç†

**æ¥å£å®šä¹‰:**
```go
type Service interface {
    CreateNode(ctx context.Context, node *entity.WfNode) error
    GetNodes(ctx context.Context, definitionID uint) ([]*entity.WfNode, error)
    UpdateNode(ctx context.Context, node *entity.WfNode) error
    DeleteNode(ctx context.Context, id uint) error
}
```

**åŠŸèƒ½ç‰¹æ€§:**
- âœ… åˆ›å»ºæµç¨‹èŠ‚ç‚¹
- âœ… æŸ¥è¯¢æµç¨‹çš„æ‰€æœ‰èŠ‚ç‚¹
- âœ… æ›´æ–°èŠ‚ç‚¹é…ç½®
- âœ… åˆ é™¤èŠ‚ç‚¹(è½¯åˆ é™¤)

#### 2.3 æµç¨‹æµè½¬ç®¡ç†

**æ¥å£å®šä¹‰:**
```go
type Service interface {
    CreateTransition(ctx context.Context, transition *entity.WfTransition) error
    GetTransitions(ctx context.Context, definitionID uint) ([]*entity.WfTransition, error)
    DeleteTransition(ctx context.Context, id uint) error
}
```

**åŠŸèƒ½ç‰¹æ€§:**
- âœ… åˆ›å»ºæµè½¬å…³ç³»
- âœ… æŸ¥è¯¢æµç¨‹çš„æ‰€æœ‰æµè½¬(æŒ‰ä¼˜å…ˆçº§æ’åº)
- âœ… åˆ é™¤æµè½¬

#### 2.4 æµç¨‹å®ä¾‹ç®¡ç†

**æ¥å£å®šä¹‰:**
```go
type Service interface {
    StartProcess(ctx context.Context, req *StartProcessRequest) (*entity.WfInstance, error)
    GetInstance(ctx context.Context, id uint) (*entity.WfInstance, error)
    ListInstances(ctx context.Context, req *ListInstancesRequest) ([]*entity.WfInstance, int64, error)
    TerminateInstance(ctx context.Context, id uint, userID uint) error
    SuspendInstance(ctx context.Context, id uint) error
    ResumeInstance(ctx context.Context, id uint) error
}
```

**å¯åŠ¨æµç¨‹è¯·æ±‚:**
```go
type StartProcessRequest struct {
    DefinitionID uint                   // æµç¨‹å®šä¹‰ID
    SysTableID   int                    // ä¸šåŠ¡è¡¨ID
    BusinessID   uint                   // ä¸šåŠ¡æ•°æ®ID
    StartUserID  uint                   // å‘èµ·äºº
    Title        string                 // æµç¨‹æ ‡é¢˜
    Variables    map[string]interface{} // æµç¨‹å˜é‡
}
```

**æµç¨‹å¯åŠ¨æµç¨‹:**
1. âœ… éªŒè¯æµç¨‹å®šä¹‰çŠ¶æ€(å¿…é¡»æ˜¯published)
2. âœ… è·å–å¼€å§‹èŠ‚ç‚¹
3. âœ… åˆ›å»ºæµç¨‹å®ä¾‹
4. âœ… è‡ªåŠ¨ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
5. âœ… æ ¹æ®èŠ‚ç‚¹ç±»å‹æ‰§è¡Œç›¸åº”æ“ä½œ

**æµç¨‹æ‰§è¡Œå¼•æ“æ ¸å¿ƒæ–¹æ³•:**
```go
func (s *service) moveToNext(
    ctx context.Context,
    instance *entity.WfInstance,
    currentNode *entity.WfNode,
    variables map[string]interface{},
) error
```

**æ‰§è¡Œæµç¨‹:**
1. âœ… è·å–å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰æµè½¬
2. âœ… è¯„ä¼°æµè½¬æ¡ä»¶,æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æµè½¬
3. âœ… è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
4. âœ… æ›´æ–°å®ä¾‹å½“å‰èŠ‚ç‚¹
5. âœ… æ ¹æ®èŠ‚ç‚¹ç±»å‹æ‰§è¡Œæ“ä½œ:
   - **userèŠ‚ç‚¹**: åˆ›å»ºç”¨æˆ·ä»»åŠ¡
   - **autoèŠ‚ç‚¹**: æ‰§è¡Œå…³è”çš„åŠ¨ä½œ,ç»§ç»­æµè½¬
   - **endèŠ‚ç‚¹**: æ ‡è®°æµç¨‹å®Œæˆ
   - **å…¶ä»–**: ç»§ç»­æµè½¬

#### 2.5 ä»»åŠ¡ç®¡ç†

**æ¥å£å®šä¹‰:**
```go
type Service interface {
    GetTask(ctx context.Context, id uint) (*entity.WfTask, error)
    ListMyTasks(ctx context.Context, userID uint, status string, page, pageSize int) ([]*entity.WfTask, int64, error)
    CompleteTask(ctx context.Context, req *CompleteTaskRequest) error
    ClaimTask(ctx context.Context, taskID, userID uint) error
    TransferTask(ctx context.Context, taskID, fromUserID, toUserID uint, comment string) error
}
```

**å®Œæˆä»»åŠ¡è¯·æ±‚:**
```go
type CompleteTaskRequest struct {
    TaskID    uint                   // ä»»åŠ¡ID
    UserID    uint                   // ç”¨æˆ·ID
    Action    string                 // approve, reject
    Comment   string                 // å®¡æ‰¹æ„è§
    Variables map[string]interface{} // ä»»åŠ¡å˜é‡
}
```

**ä»»åŠ¡å¤„ç†æµç¨‹:**
1. âœ… éªŒè¯ä»»åŠ¡æ‰§è¡Œäºº
2. âœ… éªŒè¯ä»»åŠ¡çŠ¶æ€(pending)
3. âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€å’Œå®¡æ‰¹æ„è§
4. âœ… å¦‚æœæ˜¯æ‹’ç»,ç»ˆæ­¢æµç¨‹
5. âœ… å¦‚æœæ˜¯åŒæ„,åˆå¹¶å˜é‡,ç»§ç»­æµè½¬
6. âœ… ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**å…¶ä»–ä»»åŠ¡æ“ä½œ:**
- âœ… **ç­¾æ”¶ä»»åŠ¡**: è®°å½•ç­¾æ”¶æ—¶é—´
- âœ… **è½¬äº¤ä»»åŠ¡**: å°†ä»»åŠ¡è½¬äº¤ç»™å…¶ä»–äºº

### 3. APIæ¥å£ (workflow_handler.go)

#### 3.1 æµç¨‹å®šä¹‰æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ |
|---------|------|------|
| `/api/v1/workflow/definitions` | POST | åˆ›å»ºæµç¨‹å®šä¹‰ |
| `/api/v1/workflow/definitions` | GET | æŸ¥è¯¢æµç¨‹å®šä¹‰åˆ—è¡¨ |
| `/api/v1/workflow/definitions/:id` | GET | è·å–æµç¨‹å®šä¹‰è¯¦æƒ… |
| `/api/v1/workflow/definitions/:id` | PUT | æ›´æ–°æµç¨‹å®šä¹‰ |
| `/api/v1/workflow/definitions/:id/publish` | POST | å‘å¸ƒæµç¨‹å®šä¹‰ |

#### 3.2 æµç¨‹èŠ‚ç‚¹æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ |
|---------|------|------|
| `/api/v1/workflow/nodes` | POST | åˆ›å»ºèŠ‚ç‚¹ |
| `/api/v1/workflow/nodes` | GET | æŸ¥è¯¢èŠ‚ç‚¹åˆ—è¡¨ |
| `/api/v1/workflow/nodes/:id` | PUT | æ›´æ–°èŠ‚ç‚¹ |
| `/api/v1/workflow/nodes/:id` | DELETE | åˆ é™¤èŠ‚ç‚¹ |

#### 3.3 æµç¨‹æµè½¬æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ |
|---------|------|------|
| `/api/v1/workflow/transitions` | POST | åˆ›å»ºæµè½¬ |
| `/api/v1/workflow/transitions` | GET | æŸ¥è¯¢æµè½¬åˆ—è¡¨ |
| `/api/v1/workflow/transitions/:id` | DELETE | åˆ é™¤æµè½¬ |

#### 3.4 æµç¨‹å®ä¾‹æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ |
|---------|------|------|
| `/api/v1/workflow/instances/start` | POST | å¯åŠ¨æµç¨‹ |
| `/api/v1/workflow/instances` | GET | æŸ¥è¯¢æµç¨‹å®ä¾‹åˆ—è¡¨ |
| `/api/v1/workflow/instances/:id` | GET | è·å–æµç¨‹å®ä¾‹è¯¦æƒ… |
| `/api/v1/workflow/instances/:id/terminate` | POST | ç»ˆæ­¢æµç¨‹ |

#### 3.5 ä»»åŠ¡æ¥å£

| æ¥å£è·¯å¾„ | æ–¹æ³• | åŠŸèƒ½ |
|---------|------|------|
| `/api/v1/workflow/tasks/my` | GET | æŸ¥è¯¢æˆ‘çš„ä»»åŠ¡ |
| `/api/v1/workflow/tasks/:id` | GET | è·å–ä»»åŠ¡è¯¦æƒ… |
| `/api/v1/workflow/tasks/complete` | POST | å®Œæˆä»»åŠ¡ |
| `/api/v1/workflow/tasks/:id/claim` | POST | ç­¾æ”¶ä»»åŠ¡ |
| `/api/v1/workflow/tasks/:id/transfer` | POST | è½¬äº¤ä»»åŠ¡ |

**æ€»è®¡: 19ä¸ªå·¥ä½œæµAPIæ¥å£**

### 4. æ•°æ®åº“è¡¨ç»“æ„

åˆ›å»ºäº†5ä¸ªå·¥ä½œæµç›¸å…³è¡¨:
- âœ… `wf_definition` - æµç¨‹å®šä¹‰è¡¨
- âœ… `wf_node` - æµç¨‹èŠ‚ç‚¹è¡¨
- âœ… `wf_transition` - æµç¨‹æµè½¬è¡¨
- âœ… `wf_instance` - æµç¨‹å®ä¾‹è¡¨
- âœ… `wf_task` - å·¥ä½œæµä»»åŠ¡è¡¨

SQLè„šæœ¬ä½ç½®: `sqls/workflow.sql`

## æŠ€æœ¯äº®ç‚¹

### 1. çµæ´»çš„æµç¨‹å»ºæ¨¡

- âœ… **å¯è§†åŒ–æµç¨‹è®¾è®¡**: èŠ‚ç‚¹æ”¯æŒåæ ‡ä½ç½®,å¯ç”¨äºæµç¨‹å›¾å±•ç¤º
- âœ… **å¤šç§èŠ‚ç‚¹ç±»å‹**: æ”¯æŒå¼€å§‹ã€ç»“æŸã€ç”¨æˆ·ä»»åŠ¡ã€è‡ªåŠ¨ä»»åŠ¡ã€ç½‘å…³ç­‰
- âœ… **æ¡ä»¶æµè½¬**: æ”¯æŒåŸºäºè¡¨è¾¾å¼çš„æ¡ä»¶åˆ†æ”¯
- âœ… **æµç¨‹ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒåŒä¸€æµç¨‹çš„å¤šä¸ªç‰ˆæœ¬

### 2. å¼ºå¤§çš„æ‰§è¡Œå¼•æ“

- âœ… **è‡ªåŠ¨æµè½¬**: æµç¨‹å®ä¾‹è‡ªåŠ¨æŒ‰ç…§å®šä¹‰æµè½¬
- âœ… **æ¡ä»¶è¯„ä¼°**: æ”¯æŒæµè½¬æ¡ä»¶è¡¨è¾¾å¼
- âœ… **å˜é‡ä¼ é€’**: æµç¨‹å˜é‡åœ¨èŠ‚ç‚¹é—´ä¼ é€’
- âœ… **è‡ªåŠ¨ä»»åŠ¡æ‰§è¡Œ**: é›†æˆåŠ¨ä½œæ‰§è¡Œå¼•æ“
- âœ… **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†

### 3. å®Œå–„çš„ä»»åŠ¡ç®¡ç†

- âœ… **ä»»åŠ¡åˆ†é…**: æ”¯æŒå¤šç§åˆ†é…æ–¹å¼(æŒ‡å®šç”¨æˆ·ã€å‘èµ·äººç­‰)
- âœ… **ä»»åŠ¡ç­¾æ”¶**: æ”¯æŒä»»åŠ¡ç­¾æ”¶æœºåˆ¶
- âœ… **ä»»åŠ¡è½¬äº¤**: æ”¯æŒä»»åŠ¡è½¬äº¤ç»™å…¶ä»–äºº
- âœ… **å®¡æ‰¹æ„è§**: æ”¯æŒè®°å½•å®¡æ‰¹æ„è§
- âœ… **ä»»åŠ¡ä¼˜å…ˆçº§**: æ”¯æŒä»»åŠ¡ä¼˜å…ˆçº§è®¾ç½®

### 4. ä¸šåŠ¡é›†æˆ

- âœ… **ä¸šåŠ¡æ•°æ®å…³è”**: æµç¨‹å®ä¾‹å¯å…³è”ä¸šåŠ¡è¡¨å’Œä¸šåŠ¡æ•°æ®
- âœ… **åŠ¨ä½œé›†æˆ**: è‡ªåŠ¨ä»»åŠ¡å¯æ‰§è¡ŒåŠ¨ä½œ(è„šæœ¬/URL/å­˜å‚¨è¿‡ç¨‹)
- âœ… **æƒé™æ§åˆ¶**: åŸºäºJWTçš„è®¤è¯æˆæƒ
- âœ… **å®¡è®¡è®°å½•**: å®Œæ•´çš„åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ç­‰å®¡è®¡å­—æ®µ

### 5. å¯æ‰©å±•æ€§

- âœ… **èŠ‚ç‚¹é…ç½®**: Configå­—æ®µæ”¯æŒè‡ªå®šä¹‰JSONé…ç½®
- âœ… **æµç¨‹é…ç½®**: æµç¨‹å®šä¹‰æ”¯æŒè‡ªå®šä¹‰é…ç½®
- âœ… **ä»»åŠ¡å˜é‡**: ä»»åŠ¡çº§åˆ«çš„å˜é‡æ”¯æŒ
- âœ… **æµç¨‹å˜é‡**: æµç¨‹çº§åˆ«çš„å˜é‡æ”¯æŒ

## ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: è¯·å‡å®¡æ‰¹æµç¨‹

**æµç¨‹å®šä¹‰:**
```
å¼€å§‹ â†’ éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹ â†’ äººäº‹å®¡æ‰¹ â†’ ç»“æŸ
      â†“(æ‹’ç»)          â†“(æ‹’ç»)
      â””â”€â”€â”€â”€â”€ç»ˆæ­¢â”€â”€â”€â”€â”€â”€â”€â”˜
```

**èŠ‚ç‚¹é…ç½®:**
1. **å¼€å§‹èŠ‚ç‚¹** (start)
2. **éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹** (user, assignType=role, assignValue=department_manager)
3. **äººäº‹å®¡æ‰¹** (user, assignType=role, assignValue=hr)
4. **ç»“æŸèŠ‚ç‚¹** (end)

**æµè½¬æ¡ä»¶:**
- å¼€å§‹ â†’ éƒ¨é—¨ä¸»ç®¡: æ— æ¡ä»¶
- éƒ¨é—¨ä¸»ç®¡ â†’ äººäº‹: action=approve
- éƒ¨é—¨ä¸»ç®¡ â†’ ç»“æŸ: action=reject
- äººäº‹ â†’ ç»“æŸ: action=approveæˆ–reject

**APIè°ƒç”¨:**
```javascript
// 1. åˆ›å»ºæµç¨‹å®šä¹‰(è‰ç¨¿)
POST /api/v1/workflow/definitions
{
  "name": "leave_approval",
  "displayName": "è¯·å‡å®¡æ‰¹æµç¨‹",
  "sysTableId": 10,
  "description": "å‘˜å·¥è¯·å‡å®¡æ‰¹æµç¨‹"
}

// 2. åˆ›å»ºèŠ‚ç‚¹
POST /api/v1/workflow/nodes
{
  "wfDefinitionId": 1,
  "name": "start",
  "nodeType": "start",
  "posX": 100,
  "posY": 100
}

// 3. åˆ›å»ºæµè½¬
POST /api/v1/workflow/transitions
{
  "wfDefinitionId": 1,
  "fromNodeId": 1,
  "toNodeId": 2,
  "orderno": 1
}

// 4. å‘å¸ƒæµç¨‹
POST /api/v1/workflow/definitions/1/publish

// 5. å¯åŠ¨æµç¨‹
POST /api/v1/workflow/instances/start
{
  "definitionId": 1,
  "sysTableId": 10,
  "businessId": 100,
  "title": "å¼ ä¸‰è¯·å‡3å¤©",
  "variables": {
    "days": 3,
    "reason": "äº‹å‡"
  }
}

// 6. éƒ¨é—¨ä¸»ç®¡å¤„ç†ä»»åŠ¡
POST /api/v1/workflow/tasks/complete
{
  "taskId": 1,
  "action": "approve",
  "comment": "åŒæ„è¯·å‡"
}

// 7. äººäº‹å¤„ç†ä»»åŠ¡
POST /api/v1/workflow/tasks/complete
{
  "taskId": 2,
  "action": "approve",
  "comment": "äººäº‹æ‰¹å‡†"
}
```

### åœºæ™¯2: é‡‡è´­å®¡æ‰¹æµç¨‹(å¸¦è‡ªåŠ¨ä»»åŠ¡)

**æµç¨‹å®šä¹‰:**
```
å¼€å§‹ â†’ é‡‘é¢åˆ¤æ–­ç½‘å…³ â†’ éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹ â†’ è‡ªåŠ¨æ›´æ–°çŠ¶æ€ â†’ ç»“æŸ
              â†“(é‡‘é¢>10000)
              â””â†’ æ€»ç»ç†å®¡æ‰¹ â†’â”˜
```

**èŠ‚ç‚¹é…ç½®:**
1. **å¼€å§‹èŠ‚ç‚¹** (start)
2. **é‡‘é¢åˆ¤æ–­** (gateway)
3. **éƒ¨é—¨ä¸»ç®¡å®¡æ‰¹** (user, assignType=role)
4. **æ€»ç»ç†å®¡æ‰¹** (user, assignType=user, assignValue=1)
5. **è‡ªåŠ¨æ›´æ–°çŠ¶æ€** (auto, actionId=5) - æ‰§è¡Œæ›´æ–°é‡‡è´­å•çŠ¶æ€çš„åŠ¨ä½œ
6. **ç»“æŸèŠ‚ç‚¹** (end)

**æµè½¬æ¡ä»¶:**
- å¼€å§‹ â†’ é‡‘é¢åˆ¤æ–­: æ— æ¡ä»¶
- é‡‘é¢åˆ¤æ–­ â†’ éƒ¨é—¨ä¸»ç®¡: amount <= 10000
- é‡‘é¢åˆ¤æ–­ â†’ æ€»ç»ç†: amount > 10000
- éƒ¨é—¨ä¸»ç®¡ â†’ è‡ªåŠ¨ä»»åŠ¡: action=approve
- æ€»ç»ç† â†’ è‡ªåŠ¨ä»»åŠ¡: action=approve
- è‡ªåŠ¨ä»»åŠ¡ â†’ ç»“æŸ: è‡ªåŠ¨æµè½¬

### åœºæ™¯3: æŠ¥é”€å®¡æ‰¹æµç¨‹(å¸¦ä»»åŠ¡è½¬äº¤)

**æµç¨‹:**
```
å¼€å§‹ â†’ è´¢åŠ¡å®¡æ ¸ â†’ è´¢åŠ¡ä¸»ç®¡å®¡æ‰¹ â†’ ç»“æŸ
```

**ä»»åŠ¡å¤„ç†:**
```javascript
// 1. æŸ¥è¯¢æˆ‘çš„ä»»åŠ¡
GET /api/v1/workflow/tasks/my?status=pending

// 2. ç­¾æ”¶ä»»åŠ¡
POST /api/v1/workflow/tasks/1/claim

// 3. è½¬äº¤ä»»åŠ¡(è´¢åŠ¡äººå‘˜Aè½¬ç»™è´¢åŠ¡äººå‘˜B)
POST /api/v1/workflow/tasks/1/transfer
{
  "toUserId": 5,
  "comment": "è¯·å°ç‹å¤„ç†"
}

// 4. æ–°ä»»åŠ¡æ‰§è¡Œäººå®Œæˆä»»åŠ¡
POST /api/v1/workflow/tasks/2/complete
{
  "action": "approve",
  "comment": "å®¡æ ¸é€šè¿‡",
  "variables": {
    "amount": 1000
  }
}
```

## ç³»ç»ŸAPIç»Ÿè®¡

**æ€»è®¡: 49ä¸ªAPIæ¥å£**

- è®¤è¯æˆæƒ: 6ä¸ª
- å…ƒæ•°æ®: 6ä¸ª
- å­—å…¸: 4ä¸ª
- åºå·: 4ä¸ª
- é€šç”¨CRUD: 6ä¸ª
- åŠ¨ä½œæ‰§è¡Œ: 4ä¸ª
- **å·¥ä½œæµ: 19ä¸ª** âœ¨ æ–°å¢

## å·²åˆ›å»ºæ–‡ä»¶æ¸…å•

### 1. å®ä½“å±‚
- `internal/model/entity/wf_definition.go` - æµç¨‹å®šä¹‰å®ä½“
- `internal/model/entity/wf_node.go` - æµç¨‹èŠ‚ç‚¹å®ä½“
- `internal/model/entity/wf_transition.go` - æµç¨‹æµè½¬å®ä½“
- `internal/model/entity/wf_instance.go` - æµç¨‹å®ä¾‹å®ä½“
- `internal/model/entity/wf_task.go` - å·¥ä½œæµä»»åŠ¡å®ä½“

### 2. æœåŠ¡å±‚
- `internal/service/workflow/workflow_service.go` - å·¥ä½œæµæœåŠ¡å®ç°(700+è¡Œ)

### 3. APIå±‚
- `internal/api/handler/workflow_handler.go` - å·¥ä½œæµAPIå¤„ç†å™¨(400+è¡Œ)

### 4. é…ç½®å’Œè·¯ç”±
- `internal/api/router/router.go` - æ›´æ–°(æ·»åŠ å·¥ä½œæµè·¯ç”±)
- `cmd/server/main.go` - æ›´æ–°(æ·»åŠ å·¥ä½œæµæœåŠ¡åˆå§‹åŒ–)
- `pkg/errors/errors.go` - æ›´æ–°(æ·»åŠ ErrValidation)

### 5. æ•°æ®åº“è„šæœ¬
- `sqls/workflow.sql` - å·¥ä½œæµè¡¨ç»“æ„

## ç¼–è¯‘æµ‹è¯•

âœ… **ç¼–è¯‘æˆåŠŸ**
```bash
go build -o bin/sky-server.exe cmd/server/main.go
```

## æ ¸å¿ƒæµç¨‹æ—¶åºå›¾

### å¯åŠ¨æµç¨‹æ—¶åº
```
ç”¨æˆ· â†’ API Handler â†’ Workflow Service â†’ DB
  |                    |                  |
  |-- StartProcess --->|                  |
  |                    |-- è·å–æµç¨‹å®šä¹‰ --->|
  |                    |<-----------------|
  |                    |-- éªŒè¯çŠ¶æ€ -------|
  |                    |-- è·å–å¼€å§‹èŠ‚ç‚¹ --->|
  |                    |<-----------------|
  |                    |-- åˆ›å»ºå®ä¾‹ ------->|
  |                    |<-----------------|
  |                    |-- moveToNext -----|
  |                    |-- åˆ›å»ºç”¨æˆ·ä»»åŠ¡ --->|
  |                    |<-----------------|
  |<-- è¿”å›å®ä¾‹ --------|                  |
```

### å®Œæˆä»»åŠ¡æ—¶åº
```
ç”¨æˆ· â†’ API Handler â†’ Workflow Service â†’ Action Service â†’ DB
  |                    |                    |              |
  |-- CompleteTask --->|                    |              |
  |                    |-- è·å–ä»»åŠ¡ -------->|              |
  |                    |<-------------------|              |
  |                    |-- éªŒè¯æƒé™ ---------|              |
  |                    |-- æ›´æ–°ä»»åŠ¡çŠ¶æ€ ---->|              |
  |                    |<-------------------|              |
  |                    |-- moveToNext ------|              |
  |                    |-- æ‰§è¡Œè‡ªåŠ¨ä»»åŠ¡ ---->|              |
  |                    |                    |-- Execute -->|
  |                    |                    |<-------------|
  |                    |<-------------------|              |
  |<-- æˆåŠŸ -----------|                    |              |
```

## å¾…å®ç°åŠŸèƒ½(æ‰©å±•æ–¹å‘)

### 1. æ›´å¤šä»»åŠ¡åˆ†é…æ–¹å¼
- ğŸ”œ **è§’è‰²åˆ†é…**: åŸºäºè§’è‰²åˆ†é…ä»»åŠ¡
- ğŸ”œ **éƒ¨é—¨åˆ†é…**: åŸºäºéƒ¨é—¨åˆ†é…ä»»åŠ¡
- ğŸ”œ **è¡¨è¾¾å¼åˆ†é…**: åŸºäºè¡¨è¾¾å¼åŠ¨æ€è®¡ç®—æ‰§è¡Œäºº
- ğŸ”œ **å€™é€‰äººæ± **: æ”¯æŒå€™é€‰äººæ± ,ä»»æ„å€™é€‰äººå¯ä»¥ç­¾æ”¶

### 2. æ›´å¼ºå¤§çš„æ¡ä»¶è¡¨è¾¾å¼
- ğŸ”œ **è¡¨è¾¾å¼å¼•æ“é›†æˆ**: ä½¿ç”¨govaluateç­‰è¡¨è¾¾å¼å¼•æ“
- ğŸ”œ **ä¸°å¯Œçš„è¿ç®—ç¬¦**: æ”¯æŒ ==, !=, >, <, &&, ||, in, containsç­‰
- ğŸ”œ **å‡½æ•°æ”¯æŒ**: æ”¯æŒå†…ç½®å‡½æ•°å¦‚ len(), contains(), startsWith()ç­‰

### 3. æµç¨‹ç›‘æ§å’Œç»Ÿè®¡
- ğŸ”œ **æµç¨‹ç›‘æ§**: å®æ—¶æŸ¥çœ‹æµç¨‹è¿è¡ŒçŠ¶æ€
- ğŸ”œ **èŠ‚ç‚¹ç»Ÿè®¡**: å„èŠ‚ç‚¹çš„å¤„ç†æ—¶é•¿ã€é€šè¿‡ç‡ç­‰
- ğŸ”œ **æ•ˆç‡åˆ†æ**: æµç¨‹å¹³å‡å¤„ç†æ—¶é•¿ã€ç“¶é¢ˆèŠ‚ç‚¹åˆ†æ
- ğŸ”œ **ä»»åŠ¡è¶…æ—¶æé†’**: ä»»åŠ¡è¶…è¿‡æˆªæ­¢æ—¶é—´è‡ªåŠ¨æé†’

### 4. æµç¨‹ä¼˜åŒ–
- ğŸ”œ **å­æµç¨‹**: æ”¯æŒè°ƒç”¨å­æµç¨‹
- ğŸ”œ **å¹¶è¡Œç½‘å…³**: æ”¯æŒå¹¶è¡Œä»»åŠ¡
- ğŸ”œ **åŒ…å«ç½‘å…³**: æ”¯æŒæ¡ä»¶å¹¶è¡Œ
- ğŸ”œ **äº‹ä»¶èŠ‚ç‚¹**: æ”¯æŒå®šæ—¶å™¨ã€æ¶ˆæ¯ã€ä¿¡å·ç­‰äº‹ä»¶
- ğŸ”œ **å›é€€**: æ”¯æŒä»»åŠ¡å›é€€åˆ°æŒ‡å®šèŠ‚ç‚¹
- ğŸ”œ **ä¼šç­¾**: æ”¯æŒå¤šäººä¼šç­¾,æ‰€æœ‰äººåŒæ„/ä¸€äººåŒæ„ç­‰

### 5. æµç¨‹å›¾è®¾è®¡å™¨
- ğŸ”œ **å¯è§†åŒ–è®¾è®¡**: Webæµç¨‹è®¾è®¡å™¨
- ğŸ”œ **æ‹–æ‹½è®¾è®¡**: æ‹–æ‹½æ–¹å¼åˆ›å»ºèŠ‚ç‚¹å’Œæµè½¬
- ğŸ”œ **å¯¼å…¥å¯¼å‡º**: BPMN 2.0æ ¼å¼å¯¼å…¥å¯¼å‡º
- ğŸ”œ **æµç¨‹å›¾å±•ç¤º**: è¿è¡Œæ—¶æµç¨‹å›¾é«˜äº®æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹

### 6. é€šçŸ¥é›†æˆ
- ğŸ”œ **é‚®ä»¶é€šçŸ¥**: ä»»åŠ¡åˆ†é…æ—¶å‘é€é‚®ä»¶
- ğŸ”œ **çŸ­ä¿¡é€šçŸ¥**: é‡è¦ä»»åŠ¡çŸ­ä¿¡æé†’
- ğŸ”œ **ç«™å†…æ¶ˆæ¯**: ç³»ç»Ÿå†…æ¶ˆæ¯é€šçŸ¥
- ğŸ”œ **webhook**: æ”¯æŒè‡ªå®šä¹‰webhooké€šçŸ¥

## æ€§èƒ½è€ƒè™‘

### 1. æ•°æ®åº“ä¼˜åŒ–
- âœ… **ç´¢å¼•**: æ‰€æœ‰æŸ¥è¯¢å­—æ®µå·²å»ºç´¢å¼•
- âœ… **è½¯åˆ é™¤**: ä½¿ç”¨IS_ACTIVEæ ‡è®°,ä¿ç•™å†å²æ•°æ®
- ğŸ”œ **åˆ†åŒºè¡¨**: å¤§æ•°æ®é‡æ—¶å¯¹æµç¨‹å®ä¾‹å’Œä»»åŠ¡è¡¨åˆ†åŒº
- ğŸ”œ **å½’æ¡£**: å®šæœŸå½’æ¡£å·²å®Œæˆçš„å†å²æµç¨‹

### 2. ç¼“å­˜ä¼˜åŒ–
- ğŸ”œ **æµç¨‹å®šä¹‰ç¼“å­˜**: ç¼“å­˜å·²å‘å¸ƒçš„æµç¨‹å®šä¹‰
- ğŸ”œ **èŠ‚ç‚¹ç¼“å­˜**: ç¼“å­˜æµç¨‹çš„èŠ‚ç‚¹å’Œæµè½¬ä¿¡æ¯
- ğŸ”œ **ç”¨æˆ·ä¿¡æ¯ç¼“å­˜**: ç¼“å­˜ç”¨æˆ·å’Œè§’è‰²ä¿¡æ¯

### 3. å¹¶å‘æ§åˆ¶
- âœ… **æ•°æ®åº“äº‹åŠ¡**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- ğŸ”œ **åˆ†å¸ƒå¼é”**: ä½¿ç”¨Redisåˆ†å¸ƒå¼é”é¿å…å¹¶å‘é—®é¢˜
- ğŸ”œ **ä¹è§‚é”**: ä½¿ç”¨ç‰ˆæœ¬å·å®ç°ä¹è§‚é”

## å®‰å…¨å»ºè®®

### 1. æƒé™æ§åˆ¶
- âœ… **JWTè®¤è¯**: æ‰€æœ‰æ¥å£éœ€è¦JWTè®¤è¯
- ğŸ”œ **æµç¨‹å®šä¹‰æƒé™**: æ§åˆ¶è°å¯ä»¥åˆ›å»º/ä¿®æ”¹æµç¨‹å®šä¹‰
- ğŸ”œ **æµç¨‹å¯åŠ¨æƒé™**: æ§åˆ¶è°å¯ä»¥å¯åŠ¨æµç¨‹
- ğŸ”œ **ä»»åŠ¡å¤„ç†æƒé™**: éªŒè¯ä»»åŠ¡æ‰§è¡Œäººèº«ä»½

### 2. æ•°æ®å®‰å…¨
- âœ… **å‚æ•°éªŒè¯**: æ‰€æœ‰è¾“å…¥å‚æ•°éªŒè¯
- âœ… **SQLæ³¨å…¥é˜²æŠ¤**: ä½¿ç”¨GORMå‚æ•°åŒ–æŸ¥è¯¢
- ğŸ”œ **æ•æ„Ÿæ•°æ®åŠ å¯†**: æµç¨‹å˜é‡ä¸­çš„æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨

### 3. å®¡è®¡æ—¥å¿—
- âœ… **æ“ä½œè®°å½•**: è®°å½•åˆ›å»ºäººã€åˆ›å»ºæ—¶é—´ç­‰
- ğŸ”œ **æµç¨‹æ—¥å¿—**: è®°å½•æµç¨‹æµè½¬å†å²
- ğŸ”œ **å®¡æ‰¹æ—¥å¿—**: è®°å½•å®¡æ‰¹æ„è§å’Œæ“ä½œ

## æ€»ç»“

Phase 6 æˆåŠŸå®ç°äº†å®Œæ•´çš„å·¥ä½œæµå¼•æ“:

âœ… **5ä¸ªå®ä½“æ¨¡å‹**: æµç¨‹å®šä¹‰ã€èŠ‚ç‚¹ã€æµè½¬ã€å®ä¾‹ã€ä»»åŠ¡
âœ… **å®Œæ•´çš„æµç¨‹ç”Ÿå‘½å‘¨æœŸ**: å®šä¹‰â†’å‘å¸ƒâ†’å¯åŠ¨â†’æ‰§è¡Œâ†’å®Œæˆ
âœ… **çµæ´»çš„èŠ‚ç‚¹ç±»å‹**: å¼€å§‹ã€ç»“æŸã€ç”¨æˆ·ä»»åŠ¡ã€è‡ªåŠ¨ä»»åŠ¡ã€ç½‘å…³
âœ… **å¼ºå¤§çš„æ‰§è¡Œå¼•æ“**: è‡ªåŠ¨æµè½¬ã€æ¡ä»¶è¯„ä¼°ã€å˜é‡ä¼ é€’
âœ… **å®Œå–„çš„ä»»åŠ¡ç®¡ç†**: åˆ†é…ã€ç­¾æ”¶ã€è½¬äº¤ã€å®Œæˆ
âœ… **ä¸šåŠ¡é›†æˆ**: å…³è”ä¸šåŠ¡æ•°æ®ã€é›†æˆåŠ¨ä½œæ‰§è¡Œ
âœ… **19ä¸ªAPIæ¥å£**: è¦†ç›–æµç¨‹å®šä¹‰ã€å®ä¾‹ç®¡ç†ã€ä»»åŠ¡å¤„ç†
âœ… **RESTfulè®¾è®¡**: æ¸…æ™°çš„èµ„æºåˆ’åˆ†,ç»Ÿä¸€çš„å“åº”æ ¼å¼
âœ… **æ•°æ®åº“è¡¨ç»“æ„**: å®Œæ•´çš„è¡¨ç»“æ„å’Œç´¢å¼•è®¾è®¡

ç³»ç»Ÿç°åœ¨å…·å¤‡äº†ä¼ä¸šçº§å·¥ä½œæµå¼•æ“çš„æ ¸å¿ƒèƒ½åŠ›,å¯ä»¥æ”¯æŒå¤æ‚çš„ä¸šåŠ¡å®¡æ‰¹æµç¨‹,ä¸ºç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„æµç¨‹ç¼–æ’èƒ½åŠ›ã€‚

**ç¼–è¯‘çŠ¶æ€:** âœ… æˆåŠŸ
**æ–°å¢API:** 19ä¸ªæ¥å£
**æ ¸å¿ƒèƒ½åŠ›:** æµç¨‹å®šä¹‰ã€æµç¨‹æ‰§è¡Œã€ä»»åŠ¡ç®¡ç†ã€åŠ¨ä½œé›†æˆ
