# Sky-Server 数据库设计文档

## 1. 数据库概述

### 1.1 数据库选型

- **数据库**: MySQL 8.0+
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_0900_ai_ci
- **存储引擎**: InnoDB

### 1.2 设计原则

- 所有表都包含标准审计字段（CREATE_BY, CREATE_TIME, UPDATE_BY, UPDATE_TIME）
- 使用软删除（IS_ACTIVE字段，Y:有效, N:无效）
- 多租户支持（SYS_COMPANY_ID字段）
- 主键统一使用自增INT UNSIGNED类型

## 2. 数据表分类

### 2.1 元数据表（Meta Tables）

存储系统的元数据定义，是整个系统的核心。

| 表名 | 说明 |
|------|------|
| sys_table | 表/表单定义 |
| sys_column | 字段定义 |
| sys_table_ref | 表关联关系 |
| sys_table_sql | 自定义查询SQL |
| sys_table_cmd | 表命令钩子 |
| sys_objuiconf | 对象UI配置 |

### 2.2 权限管理表（Permission Tables）

控制用户访问权限和数据隔离。

| 表名 | 说明 |
|------|------|
| sys_company | 公司（多租户） |
| sys_user | 系统用户 |
| sys_groups | 权限组 |
| sys_user_groups | 用户权限组关联 |
| sys_directory | 安全目录 |
| sys_group_prem | 权限组明细 |

### 2.3 动作管理表（Action Tables）

定义可执行的自定义动作。

| 表名 | 说明 |
|------|------|
| sys_action | 动作定义 |

### 2.4 字典管理表（Dictionary Tables）

管理下拉选项等枚举数据。

| 表名 | 说明 |
|------|------|
| sys_dict | 数据字典 |
| sys_dict_item | 数据字典明细 |

### 2.5 系统配置表（System Config Tables）

系统级配置和参数。

| 表名 | 说明 |
|------|------|
| sys_param | 系统参数 |
| sys_seq | 单据编号生成器 |
| sys_subsystem | 子系统定义 |
| sys_table_category | 表类别 |
| sys_user_env | 用户环境变量 |

### 2.6 审核流程表（Workflow Tables）

管理审核流程和审核记录。

| 表名 | 说明 |
|------|------|
| sys_audit_flow | 审核流程定义 |
| sys_approval_record | 审核记录 |

### 2.7 审计日志表（Audit Tables）

记录系统操作日志，支持数据追溯。

| 表名 | 说明 |
|------|------|
| sys_audit_log | 审计日志 |
| sys_user_session | 用户会话记录 |

## 3. 核心表详细设计

### 3.1 sys_table (系统表单)

**用途**: 定义系统中的逻辑表/表单

**关键字段**:

| 字段名 | 类型 | 说明                                                |
|--------|------|---------------------------------------------------|
| ID | INT UNSIGNED | 主键                                                |
| NAME | VARCHAR(255) | 表名（唯一）                                            |
| DISPLAY_NAME | VARCHAR(255) | 显示名称                                              |
| REAL_TABLE_ID | INT UNSIGNED | 实际数据库表ID（如果是视图）                                   |
| FILTER | VARCHAR(2000) | 数据过滤SQL                                           |
| AK_COLUMN_ID | INT | 输入键字段ID(用于其他表单关联该表单时，输入该字段的值后存储对应ID)              |
| DK_COLUMN_ID | INT UNSIGNED | 显示键字段ID(用于其他表单关联该表单时，获取ID后解析该字段value)             |
| MASK | CHAR(10) | 表单规则（A:新增,M:修改,D:删除,Q:查询,S:提交,U:反提交,V:作废,E:导出,I:导入） |
| SYS_TABLECATEGORY_ID | INT UNSIGNED | 表类别ID(该表单所在哪个折叠菜单中)                               |
| URL | VARCHAR(255) | 网页链接                                              |
| RPC_NAME | VARCHAR(255) | RPC方法名                                            |
| IS_MENU | CHAR(1) | 是否菜单（Y/N）                                         |
| IS_DROPDOWN | CHAR(1) | 是否下拉框                                             |
| SYS_OBJUICONF_ID | INT | 显示配置ID                                            |
| IS_BIG | CHAR(1) | 是否海量数据表                                           |
| PROPS | VARCHAR(2000) | 扩展属性（JSON）                                        |

**索引**:
- PRIMARY KEY (ID)
- UNIQUE INDEX IDX_SYSTABLE_NAME (NAME)

**MASK字段说明**:
- A: 允许新增
- M: 允许修改
- D: 允许删除
- Q: 允许查询
- S: 允许提交
- U: 允许反提交
- V: 允许作废
- E: 允许导出
- I: 允许导入

示例：MASK='AMDQ' 表示允许新增、修改、删除、查询

### 3.2 sys_column (系统表字段)

**用途**: 定义表的字段/列

**关键字段**:

| 字段名 | 类型            | 说明                                                                 |
|--------|---------------|--------------------------------------------------------------------|
| ID | INT UNSIGNED  | 主键                                                                 |
| SYS_TABLE_ID | INT UNSIGNED  | 所属表单ID                                                             |
| NAME | VARCHAR(255)  | 显示名称                                                               |
| DB_NAME | VARCHAR(255)  | 数据库字段名                                                             |
| FULL_NAME | VARCHAR(255)  | 字段全名（唯一）                                                           |
| COL_TYPE | VARCHAR(255)  | 字段类型（varchar,datetime,int,decimal,float,char,date,等其他mysql支持的字段类型） |
| COL_LENGTH | INT           | 字段长度                                                               |
| COL_PRECISION | INT           | 字段精度（小数）                                                           |
| IS_DK | CHAR(1)       | 是否显示键（Y/N）                                                         |
| IS_AK | CHAR(1)       | 是否输入键（Y/N）                                                         |
| NULL_ABLE | CHAR(1)       | 是否允许空值（Y/N）                                                        |
| IS_UPPERCASE | CHAR(1)       | 是否自动大写（Y/N）                                                        |
| IS_QUERY | CHAR(1)       | 是否作为查询条件（Y/N）                                                      |
| ORDERNO | INT           | 显示顺序                                                               |
| MASK | VARCHAR(10)   | 字段读写规则                                                             |
| MODIFI_ABLE | CHAR(1)       | 是否允许界面修改                                                           |
| SET_VALUE_TYPE | VARCHAR(255)  | 赋值方式                                                               |
| REF_TABLE_ID | INT UNSIGNED  | 关联表ID（外键）                                                          |
| REF_COLUMN_ID | INT UNSIGNED  | 关联字段ID                                                             |
| REF_ON_DELETE | VARCHAR(255)  | 外键删除动作                                                             |
| SEQ | VARCHAR(80)   | 单据编号生成器名称                                                          |
| SYS_DICT_ID | VARCHAR(80)   | 数据字典ID                                                             |
| DEFAULT_VALUE | VARCHAR(255)  | 默认值                                                                |
| REG_EXPRESSION | VARCHAR(255)  | 输入校验正则表达式                                                          |
| ERR_MSG | VARCHAR(255)  | 校验失败提示                                                             |
| FILTER | VARCHAR(255)  | 字段过滤器SQL                                                           |
| DISPLAY_TYPE | VARCHAR(255)  | 显示控件类型                                                             |
| DISPLAY_COLS | INT           | 显示列数                                                               |
| DISPLAY_ROWS | INT           | 显示行数                                                               |
| PROPS | VARCHAR(2000) | 扩展属性（JSON）                                                         |
| IS_SHOW_TITLE | VARCHAR(3)    | 是否显示备注(Y:是;N:否)                                                    |
| SUBMETHOD | CHAR(1)       | 统计方法（sum:求和）                                                       |
| HR_COLUMN_ID | int           | 关联HR折叠字段                                                           |
| SHOW_COLUMN_ID | int           | 级联显示字段                                                             |
| SHOW_COLUMN_VAL | VARCHAR(255)       | 级联显示条件                                                             |
| DESCRIPTION | VARCHAR(255)       | 备注                                                                 |
| SGRADE | INT           | 字段访问级别                                                             |

**索引**:
- PRIMARY KEY (ID)
- UNIQUE INDEX idx_column_full_name (FULL_NAME)

**MASK 字段读写规则**:
- 值例子：1111111111
- 说明：
- 第一个1：新增可见
- 第二个1：新增可修改
- 第三个1：修改可见
- 第四个1：修改可修改
- 第五个1：列表可见
- 第六个1: 列表可修改
- 第七个1: 导入可见
- 第八个1: 导出可见
- 第九个1: 打印可见
- 第十个1: 扩展其他


**SET_VALUE_TYPE 赋值方式**:

| 值        | 说明   | 何时赋值                        |
|----------|------|-----------------------------|
| pk       | 主键   | 新增时自动生成                     |
| docno    | 单据编号 | 新增时根据SEQ字段指定的生成器生成          |
| createBy | 创建人  | 新增时赋值为当前用户                  |
| byPage   | 界面输入 | 由用户在界面填写                    |
| select   | 下拉选择 | 从SYS_DICT_ID指定的字典选择         |
| fk       | 外键关联 | 关联到REF_TABLE_ID.REF_COLUMN_ID |
| sysdate  | 操作时间 | 新增/修改时赋值为当前时间               |
| operator | 操作用户 | 修改时赋值为当前用户                  |
| password | 密码   | 该字段输入后显示*                   |
| ignore   | 忽略   | 不处理此字段                      |

**DISPLAY_TYPE 显示控件类型**:
- blank: 空白占位
- button: 按钮
- hr: 折叠模块(包含一个或多个字段)
- check: 复选框
- file: 文件上传
- image: 图片
- select: 下拉选择
- text: 文本框
- textarea: 文本域
- date: 日期单选择
- datetime: 日期时间单选择
- clob: 超大文本
- xml: xml 文档
- json: json结构

### 3.3 sys_table_ref (关联表)

**用途**: 定义表之间的关联关系（1对1或1对多）

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| SYS_TABLE_ID | INT | 主表ID |
| REF_TABLE_ID | INT | 关联表ID |
| REF_COLUMN_ID | INT | 关联字段ID |
| DISPLAY_NAME | VARCHAR(255) | 显示描述 |
| FILTER | VARCHAR(255) | 过滤条件 |
| ASSOCTYPE | CHAR(1) | 关联方式（1:1对1, n:1对n） |
| EDIT_TYPE | CHAR(2) | 编辑方式 |
| ORDERNO | INT | 显示顺序 |

**EDIT_TYPE 编辑方式**:
- Y: 标准（新增和修改都可在内嵌窗口编辑）
- N: 无（无内嵌编辑窗口）
- NP: 非内嵌，允许弹出
- NS: 非内嵌，禁止弹出
- A: 仅显示新增字段，修改直接修改

### 3.4 sys_action (动作定义)

**用途**: 定义可附加到表的自定义动作

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| SYS_TABLE_ID | INT | 所属表单ID |
| NAME | VARCHAR(80) | 动作名称 |
| DISPLAY_NAME | VARCHAR(255) | 显示描述 |
| DISPLAY_TYPE | VARCHAR(80) | 显示样式 |
| ACTION_TYPE | VARCHAR(255) | 动作类型 |
| CONTENT | VARCHAR(255) | 动作内容 |
| SCRIPTS | VARCHAR(2000) | 脚本内容 |
| URLTARGET | VARCHAR(255) | URL目标页 |
| SAVE_OBJ | VARCHAR(80) | 是否保存对象 |
| COMMENTS | VARCHAR(255) | 提醒信息 |
| FILTER | VARCHAR(255) | 显示条件 |
| ORDERNO | INT | 排序 |

**DISPLAY_TYPE 显示样式**:
- list_button: 列表栏按钮
- list_menu_item: 列表栏菜单
- obj_button: 单对象界面按钮
- obj_menu_item: 单对象界面菜单
- tab_button: 单对象标签页按钮

**ACTION_TYPE 动作类型**:
- url: URL跳转
- sp: 存储过程
- job: 任务程序
- js: JavaScript脚本
- bsh: OS Shell脚本
- py: Python脚本
- go: golang方法

### 3.5 sys_table_cmd (表单功能扩展)

**用途**: 定义表操作前后的钩子函数

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| SYS_TABLE_ID | INT | 所属表单ID |
| ACTION_TYPE | CHAR(1) | 按钮类型（1:系统按钮） |
| ACTION | CHAR(1) | 操作类型 |
| ACTION_NAME | VARCHAR(255) | 按钮名称 |
| EVENT | VARCHAR(255) | 事件时机（begin:开始, end:结束） |
| CONTENT | VARCHAR(255) | 执行内容 |
| CONTENT_TYPE | VARCHAR(255) | 内容类型 |

**ACTION 操作类型**:
- A: 新增
- M: 修改
- D: 删除
- Q: 查询
- S: 提交
- U: 反提交
- V: 作废
- I: 导入
- E: 导出

**EVENT 事件时机**:
- begin: 操作前执行
- end: 操作后执行

**CONTENT执行内容**:
- 若 CONTENT_TYPE 为 sp 则调用数据空存储过程
- 若 CONTENT_TYPE 为 go 则调用golang 具体方法
- 若 CONTENT_TYPE 为 python\bsh 则直接运行python
- 若 CONTENT_TYPE 为 js 则前端运行 js 内容
- 若 CONTENT_TYPE 为 job则调用系统 中job 方法

### 3.6 sys_user (系统用户)

**用途**: 存储用户账户信息

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| TRUE_NAME | VARCHAR(255) | 真实姓名 |
| USERNAME | VARCHAR(255) | 用户名 |
| PASSWORD | VARCHAR(255) | 密码（加密存储） |
| PHONE | VARCHAR(20) | 手机号 |
| EMAIL | VARCHAR(255) | 邮箱 |
| LANGUAGE | VARCHAR(255) | 语言偏好 |
| IS_ADMIN | CHAR(2) | 是否管理员（Y/N） |
| SGRADE | INT | 字段访问级别 |

### 3.7 sys_groups (权限组)

**用途**: 定义权限组

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| NAME | VARCHAR(255) | 权限组名称 |
| DESCRIPTION | VARCHAR(255) | 描述 |
| SGRADE | INT | 字段访问级别 |

### 3.8 sys_group_prem (权限组明细)

**用途**: 定义权限组对目录的访问权限

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| SYS_GROUPS_ID | INT | 权限组ID |
| SYS_DIRECTORY_ID | INT | 目录ID |
| PERMISSION | INT | 权限值 |
| FILTER_OBJ | VARCHAR(255) | 数据过滤条件（JSON） |

**PERMISSION 权限值**（位运算）:
- 1: 读
- 3: 读,写
- 5: 读,提交
- 9：读,审核
- 7: 读,写,提交
- 11: 读,写,审核
- 15: 全部(无导出)
- 17: 导出
- 19: 写,导出
- 21: 读,提交,导出
- 23: 写,提交,导出
- 31: 全部
- 示例：3 = 1 + 2 (读+写)

### 3.9 sys_seq (序号生成器)

**用途**: 生成单据编号

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| NAME | VARCHAR(255) | 生成器名称 |
| DISPLAY_NAME | VARCHAR(255) | 显示名称 |
| VFORMAT | VARCHAR(255) | 格式（如：PO{YYYY}{MM}{DD}{0000}） |
| INCRE | INT | 递增步长 |
| CYCLETYPE | CHAR(1) | 循环方式（D:日, M:月, Y:年, N:不循环） |
| PREFIX | VARCHAR(10) | 前缀 |
| SUFFIX | VARCHAR(10) | 后缀 |
| CUR_DATE | VARCHAR(20) | 当前周期值 |
| CUR_NUM | INT | 当前流水号 |

**格式占位符**:
- {YYYY}: 四位年份
- {YY}: 两位年份
- {MM}: 月份
- {DD}: 日期
- {0000}: 流水号（0的个数决定补零位数）

示例：
- 格式：PO{YYYY}{MM}{DD}{0000}
- 结果：PO202601110001

### 3.10 sys_dict (数据字典)

**用途**: 定义数据字典

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| NAME | VARCHAR(255) | 字典名称 |
| DISPLAY_NAME | VARCHAR(255) | 显示名称 |
| TYPE | INT | 字段类型（0:String, 1:int） |
| DEFAULT_VALUE | VARCHAR(255) | 默认值 |
| DESCRIPTION | VARCHAR(2000) | 描述 |

### 3.11 sys_dict_item (数据字典明细)

**用途**: 字典的具体选项

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| SYS_DICT_ID | INT UNSIGNED | 所属字典ID |
| DISPLAY_NAME | VARCHAR(255) | 显示名称 |
| VALUE | VARCHAR(255) | 字典值 |
| ORDERNO | INT | 排序 |
| CSSCLASS | VARCHAR(255) | CSS类 |
| IS_DEFAULT_VALUE | CHAR(1) | 是否默认值（Y/N） |

## 4. 表关系图

```
sys_company (公司)
    ↓ (1:n)
sys_user (用户)
    ↓ (n:m)
sys_user_groups ← → sys_groups (权限组)
                        ↓ (1:n)
                   sys_group_prem (权限明细)
                        ↓ (n:1)
                   sys_directory (安全目录)
                        ↓ (1:1)
                   sys_table (表定义)
                        ↓ (1:n)
                   ┌────┴─────┬──────────┬─────────┐
                   ↓          ↓          ↓         ↓
            sys_column  sys_table_ref  sys_action  sys_table_cmd
                   ↓
            ┌──────┼──────┐
            ↓      ↓      ↓
        sys_dict  sys_seq  REF_TABLE_ID
            ↓
      sys_dict_item
```

## 5. 标准字段说明

所有业务表都应包含以下标准字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键，自增 |
| SYS_COMPANY_ID | INT UNSIGNED | 所属公司ID（多租户隔离） |
| CREATE_BY | VARCHAR(80) | 创建人 |
| CREATE_TIME | DATETIME | 创建时间 |
| UPDATE_BY | VARCHAR(80) | 更新人 |
| UPDATE_TIME | DATETIME | 更新时间 |
| IS_ACTIVE | CHAR(1) | 是否有效（Y:可用, N:不可用） |

## 6. 数据库优化建议

### 6.1 索引策略

**必须建立索引的字段**:
- 主键（PRIMARY KEY）
- 外键字段
- 经常作为查询条件的字段（如NAME、USERNAME）
- 唯一约束字段（如sys_table.NAME, sys_column.FULL_NAME）

**复合索引建议**:
```sql
-- sys_user_groups: 用户和权限组联合查询
CREATE INDEX idx_user_groups ON sys_user_groups(SYS_USER_ID, SYS_DIRECTORY_ID);

-- sys_column: 按表ID查询字段
CREATE INDEX idx_column_table ON sys_column(SYS_TABLE_ID, ORDERNO);

-- sys_dict_item: 按字典ID查询项
CREATE INDEX idx_dict_item_dict ON sys_dict_item(SYS_DICT_ID, ORDERNO);
```

### 6.2 分区策略

对于大数据量的日志表、历史数据表，可以考虑按时间分区：

```sql
-- 示例：按月分区的日志表
CREATE TABLE sys_log (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    log_time DATETIME NOT NULL,
    -- 其他字段
    PRIMARY KEY (id, log_time)
) PARTITION BY RANGE (YEAR(log_time) * 100 + MONTH(log_time)) (
    PARTITION p202601 VALUES LESS THAN (202602),
    PARTITION p202602 VALUES LESS THAN (202603),
    -- ...
);
```

### 6.3 查询优化

1. **避免SELECT ***：明确指定需要的字段
2. **使用LIMIT**: 列表查询必须分页
3. **避免在WHERE中使用函数**: 会导致索引失效
4. **合理使用JOIN**: 不要超过3个表的JOIN

### 6.4 数据归档

定期归档历史数据：
- 软删除的数据（IS_ACTIVE='N'）
- 超过一年的审计日志
- 已完成的单据数据

## 7. 数据迁移和版本控制

### 7.1 版本命名规则

```
V{major}.{minor}.{patch}__{description}.sql

示例：
V1.0.0__init_schema.sql          # 初始化架构
V1.0.1__add_user_email.sql       # 添加用户邮箱字段
V1.1.0__add_attachment_table.sql # 添加附件表
```

### 7.2 迁移工具

推荐使用 **golang-migrate** 或 **Flyway** 进行数据库版本管理。

## 8. 业务表补充设计

所有业务表（非sys_开头的表）都应包含以下补充字段以支持审核流程：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| DOC_STATUS | VARCHAR(20) | 单据状态（DRAFT/SUBMITTED/APPROVED/VOIDED） |
| SUBMIT_BY | VARCHAR(80) | 提交人 |
| SUBMIT_TIME | DATETIME | 提交时间 |
| APPROVE_BY | VARCHAR(80) | 审核人 |
| APPROVE_TIME | DATETIME | 审核时间 |

**DOC_STATUS单据状态说明**：
- DRAFT: 草稿状态，可以修改和删除
- SUBMITTED: 已提交，等待审核，不可修改
- APPROVED: 已审核通过，不可修改
- VOIDED: 已作废，不可修改

### 8.1 sys_audit_flow (审核流程定义)

**用途**: 定义表的审核流程，支持多级审核

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | INT UNSIGNED | 主键 |
| SYS_TABLE_ID | INT UNSIGNED | 所属表单ID |
| STEP | INT | 审核步骤（1,2,3...） |
| STEP_NAME | VARCHAR(255) | 步骤名称（如：部门主管审核、财务审核） |
| APPROVER_GROUP_ID | INT UNSIGNED | 审核人权限组ID |
| IS_REQUIRED | CHAR(1) | 是否必须（Y/N） |
| IS_PARALLEL | CHAR(1) | 是否并行审核（Y:组内任一人审核即可, N:需全部审核） |
| ORDERNO | INT | 排序 |

**索引**:
- PRIMARY KEY (ID)
- INDEX idx_audit_flow_table (SYS_TABLE_ID, STEP)

**使用场景**:
```
示例：采购订单审核流程
步骤1: 部门主管审核（必须）
步骤2: 财务审核（必须）
步骤3: 总经理审核（金额>10万时必须）
```

### 8.2 sys_approval_record (审核记录)

**用途**: 记录审核历史

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | BIGINT UNSIGNED | 主键 |
| TABLE_NAME | VARCHAR(255) | 表名 |
| RECORD_ID | INT UNSIGNED | 记录ID |
| FLOW_STEP | INT | 审核步骤 |
| APPROVER_ID | INT UNSIGNED | 审核人ID |
| APPROVER_NAME | VARCHAR(255) | 审核人姓名 |
| ACTION | VARCHAR(20) | 操作（APPROVE/REJECT） |
| COMMENT | VARCHAR(1000) | 审核意见 |
| CREATE_TIME | DATETIME | 审核时间 |
| IP_ADDRESS | VARCHAR(50) | IP地址 |

**索引**:
- PRIMARY KEY (ID)
- INDEX idx_approval_table_record (TABLE_NAME, RECORD_ID)
- INDEX idx_approval_approver (APPROVER_ID, CREATE_TIME)

### 8.3 sys_audit_log (审计日志)

**用途**: 记录所有关键操作，支持数据追溯

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | BIGINT UNSIGNED | 主键 |
| TABLE_NAME | VARCHAR(255) | 表名 |
| RECORD_ID | INT UNSIGNED | 记录ID |
| ACTION | VARCHAR(20) | 操作（CREATE/UPDATE/DELETE/SUBMIT/APPROVE/VOID） |
| USER_ID | INT UNSIGNED | 操作用户ID |
| USERNAME | VARCHAR(255) | 用户名 |
| COMPANY_ID | INT UNSIGNED | 公司ID |
| OLD_VALUE | TEXT | 变更前的值（JSON格式） |
| NEW_VALUE | TEXT | 变更后的值（JSON格式） |
| CHANGES | TEXT | 字段变更明细（JSON格式） |
| IP_ADDRESS | VARCHAR(50) | IP地址 |
| USER_AGENT | VARCHAR(500) | 用户代理 |
| CREATE_TIME | DATETIME | 操作时间 |

**索引**:
- PRIMARY KEY (ID)
- INDEX idx_audit_table_record (TABLE_NAME, RECORD_ID)
- INDEX idx_audit_user (USER_ID, CREATE_TIME)
- INDEX idx_audit_time (CREATE_TIME)
- INDEX idx_audit_action (ACTION, CREATE_TIME)

**CHANGES字段格式示例**:
```json
{
  "NAME": {
    "oldValue": "张三",
    "newValue": "张三丰"
  },
  "EMAIL": {
    "oldValue": "zhangsan@example.com",
    "newValue": "zhangsanfeng@example.com"
  }
}
```

### 8.4 sys_user_session (用户会话记录)

**用途**: 管理用户登录会话，支持单点登录和多设备管理

**关键字段**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| ID | BIGINT UNSIGNED | 主键 |
| USER_ID | INT UNSIGNED | 用户ID |
| COMPANY_ID | INT UNSIGNED | 公司ID |
| TOKEN | VARCHAR(500) | JWT Token |
| REFRESH_TOKEN | VARCHAR(500) | 刷新Token |
| CLIENT_TYPE | VARCHAR(20) | 客户端类型（web/mobile/desktop） |
| DEVICE_ID | VARCHAR(255) | 设备唯一标识 |
| DEVICE_NAME | VARCHAR(255) | 设备名称 |
| IP_ADDRESS | VARCHAR(50) | IP地址 |
| USER_AGENT | VARCHAR(500) | 用户代理 |
| LOGIN_TIME | DATETIME | 登录时间 |
| LAST_ACTIVE_TIME | DATETIME | 最后活跃时间 |
| EXPIRE_TIME | DATETIME | 过期时间 |
| IS_ACTIVE | CHAR(1) | 是否有效（Y/N） |

**索引**:
- PRIMARY KEY (ID)
- UNIQUE INDEX idx_session_device (USER_ID, DEVICE_ID)
- INDEX idx_session_user (USER_ID, IS_ACTIVE)
- INDEX idx_session_token (TOKEN(255))

**使用场景**:
- 用户可以在多个设备同时登录
- 可以查看所有活跃会话
- 可以踢出指定设备
- 可以登出所有设备

## 9. 安全建议

### 9.1 密码存储

- 用户密码必须使用 **bcrypt** 加密存储
- 不存储明文密码
- 密码字段长度至少255字符（存储hash值）

### 8.2 SQL注入防护

- 所有查询使用参数化查询
- 元数据中的SQL片段需要白名单验证
- 过滤用户输入的特殊字符

### 8.3 数据备份

- 每日全量备份
- 每小时增量备份binlog
- 备份文件加密存储
- 定期演练恢复流程

## 9. 附录

### 9.1 常用SQL查询示例

**查询某个表的所有字段定义**:
```sql
SELECT c.*
FROM sys_column c
JOIN sys_table t ON c.SYS_TABLE_ID = t.ID
WHERE t.NAME = 'sys_user'
ORDER BY c.ORDERNO;
```

**查询用户的所有权限**:
```sql
SELECT d.NAME, gp.PERMISSION
FROM sys_user_groups ug
JOIN sys_groups g ON ug.SYS_DIRECTORY_ID = g.ID
JOIN sys_group_prem gp ON g.ID = gp.SYS_GROUPS_ID
JOIN sys_directory d ON gp.SYS_DIRECTORY_ID = d.ID
WHERE ug.SYS_USER_ID = 1 AND ug.IS_ACTIVE = 'Y';
```

**查询某个字典的所有选项**:
```sql
SELECT di.*
FROM sys_dict_item di
JOIN sys_dict d ON di.SYS_DICT_ID = d.ID
WHERE d.NAME = 'gender' AND di.IS_ACTIVE = 'Y'
ORDER BY di.ORDERNO;
```
